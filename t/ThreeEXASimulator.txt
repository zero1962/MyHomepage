<!DOCTYPE html>
<html lang="ja">
<title>ThreeEXASimulator</title>
<head>

<!-- --------------------------------------------------------------------------
ThreeEXASimulator is AI 3D humaniod software (Ver 3.0) 2017.12.13
Coding by kuniyuki.tsujimoto

-------------------------------------------------------------------------------
Compiled unnecessary, without special 3D viewer, You can display any three-dimensional
 models in only Web browser.
The VRML Aircraft Museum There are data of a three-dimensional model VRML format of
a lot of aircraft.
By converting them into obj format in Blender, you can display all.
You can view the three-dimensional display in WindowsPC / Mac / Linux / iOS terminal.

-------------------------------------------------------------------------------
kuniyuki.tsujimoto1182@nifty.com
http://zero1962.world.coocan.jp/
Please to follow me on FaceBook.

-------------------------------------------------------------------------------
◎良いところ：
・特別な３Ｄ表示ビューアを必要としない。
・iPhoneでもPCでも同じデータが表示できる。
・コンパイル不要。
・お金がかからない。

-------------------------------------------------------------------------------
○使い方：
・ボタンをクリックして操作します。
・iOSの場合、画面をスライドして拡大縮小視点変更できます。
・PCの場合、マウス操作で拡大縮小視点変更できます。
・VRML/MMDのモデルは、BlenderでOBJ/MTL形式ファイルに変換することで表示できます。

-------------------------------------------------------------------------------
♪製品仕様：
・z軸マイナス方向が機体軸方向正とする。画面奥行方向。
・Three.js/WebGLを用いることで、PCでもiOSでも3Dを表示できる。
・AI機体（ランダム飛行、飛行経路トレース）
・GUIメニューのチェックリストで、表示項目のON/OFF設定する。

-------------------------------------------------------------------------------
□注意事項：
・IE10以下では、動作しません。
・OBJLoader/GUIMenuは、Webサーバ実行時有効です。
・IE/chromeではOBJLoaderが使えません。FirefoxのみOK。
・ローカルのIE/chromeで実行する場合は、OBJLoader/ModeMenuをコメントアウトしてください。

-------------------------------------------------------------------------------
△問題点：
・メッセージ表示領域がせまく最新のメッセージが見えない。
・SkyBox をremoveできない。
・FLDを表示するといくつかのMMDモデルは表示できない。メモリ不足
・iPhone6でBufferLoader完了しないためサウンド再生できない。iPhone5Sでは機能する。
・音声と、セリフ表示のタイミングがずれる。
・iOSで音声がでない。(2017.03.19 解決)
・速度ベクトルの座標変換が正しくない。Euler角90deg以上で符号が変わるYaw改善済。2016.11.10 解決
・表示画素数の多いOBJモデルは、時々消えます。WebGLのキャッシュ拡大できるの？
・地形データの色が、元のVRMLデータの通りにならない。
・VRMLのようにプロペラを回せない。
・OBJモデルのアニメ動作方法がわからない。MikuMikuAIのように。
・JavaScriptといっても、Three.js/VRML/htmlで関数が違う？
・コメント文が多いと起動／実行が遅くなる。( JavaScript はインタプリタだった？)

-------------------------------------------------------------------------------
▽その他：
・改造再配布は、ご自身の責任でお願いします。
・ご意見、ご質問は、上記にメール願います。
・要望、アイデアをお待ちしております。

-------------------------------------------------------------------------------
◇履歴：
2017.12.13 wed SkyBox,FLD の追加
2017.12.12 tue RV-6A に素子が搭乗できるようになった。
2017.12.11 mon AI エクサと連動できた。
2017.04.02 sun ドロップシャドウが可能になって影も動くようになった。
2017.03.21 tue 言葉入力機能を追加した。
2017.03.19 sun iOSでも音声がでるようになった。セリフのサイズを調整しスクロールする。
2017.03.12 sun 音声合成、文字表示できるようになった。
2016.11.28 mon Textureのパスはsetpathで通るようになった。
2016.11.12 sat FireFox最新版ならOBJLoaderがローカルPCで実行できる。
2016.11.11 fri Ver 1.3
2016.11.10 thu 自作クォータニオン関数による航法計算で問題解決できた。
2016.11.10 thu 仕様追加
2016.11.09 wed クォータニオン関数化
2016.11.07 mon ランダム地形、太陽光、鳥の群れ、霧
2016.11.01 tue 簡易機体形状、練習用飛行経路設定した。
2016.10.30 sun Camera Lookup 成功。ｺｸﾋﾟｯﾄﾋﾞｭｰも改善し、MRJ90版も作成した。
2016.10.29 sat 古いIE9/Chrom(on WindoesVista)では動作しない。
2016.10.28 fri 数値表示できた。しかし、iOSでは表示できない。
2016.10.22 Ver 1.0 新規コーディング

--------------------------------------------------------------------------- -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="Description" content="jsdo.it - share JavaScript, HTML5 and CSS -" />
<meta name="Keywords"    content="JavaScript,HTML5,CSS" />
<meta name="viewport"    content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1" />

<!-- --------------------------------------------------------------------------
スタイル
--------------------------------------------------------------------------- -->
<style type="text/css">
body {
	background:#000;
	color: #eee;
	padding:0;
	margin:0;
	font-weight:bold;
	overflow:hidden;
	font-family:Monospace;
	font-size:13px;
}

div#canvas-frame{
	border: none;
	cursor: pointer;
	height: 0px;
	background-color: #EEEEEE;
	max-width: 100%;
}
div#canvas-frame canvas{
	max-width: 100%;
}

a {
	color: #555;
}

#container {
	padding: 0;
	margin: 0;
	opacity: 1;
}

#info { position: absolute; top: 60px; left: 20px; font-size: 12px;}

#WhoButton {
	position: absolute;
	right: 10px;
	top:   25px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#View_Button {
	position: absolute;
	right: 10px;
	top:   70px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#STP_Button {
	color: #FF0000;
	position: absolute;
	left:   120px;
	bottom: 10px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#Go_Button {
	color: #0000FF;
	position: absolute;
	left:  250px;
	bottom: 10px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#Back_Button {
	color: #0000FF;
	position: absolute;
	left:   10px;
	bottom: 10px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#YR_Button {
	color: #00FF00;
	position: absolute;
	left:  250px;
	bottom: 80px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#YL_Button {
	color: #00FF00;
	position: absolute;
	left:   10px;
	bottom: 80px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#PU_Button {
	color: #00FF00;
	position: absolute;
	left:   120px;
	bottom: 160px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#PD_Button {
	color: #00FF00;
	position: absolute;
	left:   120px;
	bottom: 80px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#RR_Button {
	color: #00FF00;
	position: absolute;
	left:  250px;
	bottom: 160px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

#RL_Button {
	color: #00FF00;
	position: absolute;
	left:   10px;
	bottom: 160px;
	opacity: 0.4;
	font-size: 15px;
	border : solid 0px #ffffff;
	border-radius : 15px;
	moz-border-radius : 15px;
	padding : 4px 6px;
	background-color : #77FF77;
}

/*************************************
文字入力
**************************************/
#contents {
	width: 100%;
	height: 100%;
}

#control {
	position: absolute;
	left: 50%;
	margin-left: -162px;
	opacity: 0;
}

#labelName {
	display: none;
}

#labelKaiwa {
	height: 24px;
	width: 200px;
	float: left;
	margin-left: 12px;
	padding-left: 10px;
	font-size: 16px;
	color: #000000;
	border: solid 2px #FF0000;
	border-radius: 5px;
	-webkit-border-radius: 5px;
	-moz-border-radius: 5px;
}

#btn {
	height: 32px;
	width: 50px;
	float: left;
	margin-left: 4px;
	font-size: 16px;
	color: #78b6ff;
	font-weight: bold;
	cursor: pointer;
	border: solid 1px #113b82;
	border-radius: 5px;
	-webkit-border-radius: 5px;
	-moz-border-radius: 5px;
	background: #4c95ec;
	background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzRjOTVlYyIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMzMTZhYzMiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
	background: -moz-linear-gradient(top,  #4c95ec 0%, #316ac3 100%);
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#4c95ec), color-stop(100%,#316ac3));
	background: -webkit-linear-gradient(top,  #4c95ec 0%,#316ac3 100%);
	background: -o-linear-gradient(top,  #4c95ec 0%,#316ac3 100%);
	background: -ms-linear-gradient(top,  #4c95ec 0%,#316ac3 100%);
	background: linear-gradient(to bottom,  #4c95ec 0%,#316ac3 100%);
}

.grab {
	cursor:grab;
	cursor:-moz-grab;
	cursor:-webkit-grab;
}
.grabbing {
	cursor:grabbing;
	cursor:-moz-grabbing;
	cursor:-webkit-grabbing;
}

/*************************************
会話バルーン
**************************************/
#overlay {
	position: absolute;
	left:   10px;
	top:    100;
	width:  40%;
	height: 80%;
}

#scrollarea {
	left:   10px;
	top:    100;
	width:  100%;
	height: 60%;
	overflow: hidden;
}

#henji {
	width: 812px;
	margin: 0 auto;
	opacity: 0.4;
}

.align_top {
	height: 300px;
}

.align_bottom {
	height: 1px;
	moz-border-radius : 1px;
	padding : 1px 1px;
}

.align_left {
	text-align: left;
	margin-bottom: 1px;
}

.align_right {
	text-align: left;
	margin-left: 1px;
	margin-bottom: 1px;
}

.brain_say {
	padding: 5px;
	color: #121212;
	text-align: left;
	font-size: 10px;
	font-weight: bold;
	line-height: 21px;
	border-radius: 5px;
	-webkit-border-radius: 22px;
	-moz-border-radius: 22px;
	-webkit-box-shadow: 0 2px 3px 0 rgba(0,0,0,0.6);
	-moz-box-shadow: 0 2px 3px 0 rgba(0,0,0,0.6);
	box-shadow: 0 2px 3px 0 rgba(0,0,0,0.6);
	background: #ffffff;
	background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNkM2Q1ZDgiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
	background: -moz-linear-gradient(top,  #ffffff 0%, #d3d5d8 100%);
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(100%,#d3d5d8));
	background: -webkit-linear-gradient(top,  #ffffff 0%,#d3d5d8 100%);
	background: -o-linear-gradient(top,  #ffffff 0%,#d3d5d8 100%);
	background: -ms-linear-gradient(top,  #ffffff 0%,#d3d5d8 100%);
	background: linear-gradient(to bottom,  #ffffff 0%,#d3d5d8 100%);
	opacity: 0.8;
}

.you_say {
	padding: 5px;
	color: #0000FF;
	text-align: left;
	font-size: 10px;
	font-weight: bold;
	line-height: 21px;
	border-radius: 5px;
	-webkit-border-radius: 22px;
	-moz-border-radius: 22px;
	-webkit-box-shadow: 0 2px 3px 0 rgba(0,0,0,0.6);
	-moz-box-shadow: 0 2px 3px 0 rgba(0,0,0,0.6);
	box-shadow: 0 2px 3px 0 rgba(0,0,0,0.6);
	background: #c0f17a;
	background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2MwZjE3YSIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM4N2NlNDUiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
	background: -moz-linear-gradient(top,  #c0f17a 0%, #87ce45 100%);
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#c0f17a), color-stop(100%,#87ce45));
	background: -webkit-linear-gradient(top,  #c0f17a 0%,#87ce45 100%);
	background: -o-linear-gradient(top,  #c0f17a 0%,#87ce45 100%);
	background: -ms-linear-gradient(top,  #c0f17a 0%,#87ce45 100%);
	background: linear-gradient(to bottom,  #c0f17a 0%,#87ce45 100%);
	opacity: 0.8;
}

</style>
<!-- --------------------------------------------------------------------------

--------------------------------------------------------------------------- -->
</head>
<body>
<div id="canvas-frame"></div>
<div id="contents">
	<div id="spin_icon"></div>
</div>
<div id="container" class="grab"></div>
<div id="spin_icon"></div>

<div id="control">
	<form method="POST">
		<input type="text" name="name"  id="labelName" size="40" value="">
		<input type="text" name="kaiwa" id="labelKaiwa" size="40" value="発言">
		<input type="SUBMIT" id="btn" value="送信">
	</form>
</div>
<div id="overlay">
	<div id="scrollarea">
		<div id="henji">
			<div class="align_bottom"></div>
		</div>
	</div>
</div>
<div id="info">
	<a href="./ThreeEXASimulator.txt"> This source code. </a>
</div>

<!-- --------------------------------------------------------------------------
インプット・フォーム
--------------------------------------------------------------------------- -->
<FORM name="f1">
<input id=   "WhoButton" type="button" value="Who?"  onclick=   "WhoButtonHandler()">
<input id= "View_Button" type="button" value="View"  onclick= "View_ButtonHandler()">
<input id=  "STP_Button" type="button" value="STP"   onclick=  "STP_ButtonHandler()">
<input id=   "Go_Button" type="button" value="Go"    onclick=   "Go_ButtonHandler()">
<input id= "Back_Button" type="button" value="Bk"    onclick= "Back_ButtonHandler()">
<input id=   "YR_Button" type="button" value="YR"    onclick=   "YR_ButtonHandler()">
<input id=   "YL_Button" type="button" value="YL"    onclick=   "YL_ButtonHandler()">
<input id=   "PU_Button" type="button" value="PU"    onclick=   "PU_ButtonHandler()">
<input id=   "PD_Button" type="button" value="PD"    onclick=   "PD_ButtonHandler()">
<input id=   "RR_Button" type="button" value="RR"    onclick=   "RR_ButtonHandler()">
<input id=   "RL_Button" type="button" value="RL"    onclick=   "RL_ButtonHandler()">
</FORM>

<!-- --------------------------------------------------------------------------
関連 JavaScripts
--------------------------------------------------------------------------- -->
<script type="text/javascript" src="js/three.js">        	</script>
		<script src="js/libs/mmdparser.min.js"></script>
<script type="text/javascript" src="js/ShadowMesh.js">   	</script>
<script type="text/javascript" src="js/OrbitControls.js">	</script>
<script type="text/javascript" src="js/DDSLoader.js">    	</script>
<script type="text/javascript" src="js/TGALoader.js">    	</script>
<script type="text/javascript" src="js/MTLLoader.js">    	</script>
<script type="text/javascript" src="js/OBJLoader.js">    	</script>
<script type="text/javascript" src="js/libs/stats.min.js">    	</script>
<script type="text/javascript" src="js/spin.min.js">     	</script>
<script type="text/javascript" src="js/dat.gui.min.js">  	</script>
<script type="text/javascript" src="js/FirstPersonControls.js">	</script>
<script type="text/javascript" src="js/ImprovedNoise.js">	</script>
<script type="text/javascript" src="js/Detector.js">		</script>
<script type="text/javascript" src="js/Projector.js">		</script>
<script type="text/javascript" src="js/CanvasRenderer.js">	</script>
<script type="text/javascript" src="js/SkyShader.js">		</script>
<script type="text/javascript" src="js/libs/charsetencoder.min.js"></script>
<script type="text/javascript" src="js/libs/ammo.js">		</script>
<script type="text/javascript" src="js/MMDLoader.js">		</script>
<script type="text/javascript" src="js/OutlineEffect.js">	</script>
<script type="text/javascript" src="js/CCDIKSolver.js">		</script>
<script type="text/javascript" src="js/MMDPhysics.js">		</script>
<script type="text/javascript" src="js/BufferLoader.js">	</script>
<script type="text/javascript" src="js/utils/ShadowMapViewer.js"></script>
<script type="text/javascript" src="js/ConvexObjectBreaker.js">	</script>
<script type="text/javascript" src="js/ConvexGeometry.js">	</script>

<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/jquery.cookie.js"></script>
<!-- ---------------------------
-------------------------------------------- -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>

<!-- ----------------------------------------------------------------------- -->
<script type="text/javascript">

	if (!Detector.webgl) {
		Detector.addGetWebGLMessage();
		//WebGL非対応の初期表示設定
		$("#control").css("left","50%");
		$("#control").css("margin-left","-162px");
		$("#control").css("top","50%");
		$("#control").css("margin-top","163px");
		$("#control").css("opacity","1.0");
	} else {
		//WebGL対応の初期表示設定
		$("#control").css("right","0%");
		$("#control").css("bottom","40px");
		$("#henji").css("width","1000px");
		//jQueryUI
		$("#drug_range").css("width", $(window).innerWidth());
		$("#drug_range").css("height", $(window).innerHeight());
	//	$("#control").draggable({
	//		containment: "#drug_range",
	//		scroll: false,
	//	});
		$("#control").css("cursor","move");
	
	//ローディングアイコン表示
		spinPreparation();
		spinner.spin(spintarget);
	}

/*------------------------------------------------------------------------------
JavaScript  グローバル変数宣言
------------------------------------------------------------------------------*/
var clock = new THREE.Clock();
var frameTime = 0;
var Time = 0;
var stats;
var controls0, controls1, controls2, controls3;
//
var renderer = new THREE.WebGLRenderer({antialias: true});
var scene = new THREE.Scene();
//scene.fog = new THREE.Fog( 0x303030, 300, 3000 );
scene.fog = new THREE.Fog( 0x909090, 300, 15000 );

var SHADOW_MAP_WIDTH = 5000, SHADOW_MAP_HEIGHT = 4000;
var light;
var lightShadowMapViewer;
var useDirectionalLight = true;
var lightSphere, lightHolder;
var sunLight = new THREE.SpotLight( 0xffcccc, 1, 0, Math.PI / 2 );
//

var SCREEN_WIDTH  = window.innerWidth;
var SCREEN_HEIGHT = window.innerHeight;

var activeCamera;
var camera   = new THREE.PerspectiveCamera( 80, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 500000 );
//
var camera0  = new THREE.PerspectiveCamera( 55, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 500000 );
var camera1  = new THREE.PerspectiveCamera( 60, SCREEN_WIDTH / SCREEN_HEIGHT, 0.095, 3000000 );
var camera2  = new THREE.PerspectiveCamera( 55, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 500000 );
var camera3  = new THREE.PerspectiveCamera( 55, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 500000 );
var camera4  = new THREE.PerspectiveCamera( 60, SCREEN_WIDTH / SCREEN_HEIGHT, 0.095, 3000000 );
//
var normalVector = new THREE.Vector3( 0, 1, 0 );
var planeConstant = 0.01;
var groundMesh;
var groundPlane = new THREE.Plane( normalVector, planeConstant );
//
var Menu = {};
//
var  Plane_No 		= 0;
var  Who_BTN_No 	= 0;
var View_BTN_No 	= 0;
var  STP_BTN_Status 	= true;
var   Go_BTN_Status 	= true;
var Back_BTN_Status 	= true;
var   YR_BTN_Status 	= true;
var   YL_BTN_Status 	= true;
var   PU_BTN_Status 	= true;
var   PD_BTN_Status 	= true;
var   RR_BTN_Status 	= true;
var   RL_BTN_Status 	= true;
var rad_Yaw 		= 0.0;
var rad_Pitch 		= 0.0;
var rad_Roll 		= 0.0;
//
var grid,  axis_n,  axis_v;
var Hanger2 = new THREE.Group();
var Fense = new THREE.Group();
var SHouse = new THREE.Group();
var LogHouse = new THREE.Group();
var UTAU    = new THREE.Group();
var UTAU1F  = new THREE.Group();
var UTAU2F  = new THREE.Group();
var UTAU3F  = new THREE.Group();
var UTAU_1F = new THREE.Group();
var UTAU_E  = new THREE.Group();
var TOYOTA200GT = new THREE.Group();
var zero21 = new THREE.Group();
var chair  = new THREE.Group();
var Desk   = new THREE.Group();
var FLD    = new THREE.Group();
var skyBox = new THREE.Group();
var Skydome = new THREE.Group();
var Fuji = new THREE.Group();
var Auckland = new THREE.Group();
var GreenMesh = new THREE.Group();
var SeaMesh   = new THREE.Group();
var mesh  = new THREE.Group();
var Plane = new THREE.Group();
var Plane2 = new THREE.Group();
var Pilot = new THREE.Group();
var Buffer1 = new THREE.Group();
var Buffer2 = new THREE.Group();
var Buffer3 = new THREE.Group();
var Cockpit;
var propDelta = 7;
var RV6A_propMesh  = new THREE.Group();
var YS11R_propMesh  = new THREE.Group();
var YS11L_propMesh  = new THREE.Group();
var HIEN_propMesh  = new THREE.Group();
var HIEN_propMesh1 = new THREE.Group();
var HIEN_propMesh2 = new THREE.Group();
//
var YS11_Gear     = new THREE.Group();
var Q_Gear = new THREE.Quaternion();
//
var valueNode,valueNode1,valueNode2,valueNode3;
var sky, sunSphere;
var lastTime = (new Date()).getTime();
//
var X_axis  = new THREE.Vector3( 1,  0,  0 ).normalize();
var Y_axis  = new THREE.Vector3( 0,  1,  0 ).normalize();
var Z_axis  = new THREE.Vector3( 0,  0,  1 ).normalize();
var Qaxis   = new THREE.Quaternion();
var Qbuff   = new THREE.Quaternion();
var Qbuff2  = new THREE.Quaternion();
var Qbuff3  = new THREE.Quaternion();
var target  = new THREE.Quaternion();
var Qmodel  = new THREE.Quaternion();
var Qviewd  = new THREE.Quaternion();
var P       = new THREE.Vector3( 0,  0,  0 );
var A_b     = new THREE.Vector3( 0,  0,  0 );  // 機体姿勢
var V       = new THREE.Vector3( 0,  0,  0 );  // 速度
var Av_b    = new THREE.Vector3( 0,  0,  0 );  // 機体座標系角速度
//
var DCM_bL  = [ 0, 0, 0,
	 	0, 0, 0,
		0, 0, 0 ];
//
var loader;
var helper;
var ready = false;
var onProgress;
var onError;
var modelFile;
//
var vmds = [];
var vpds = [];

var clip;
var action;
var random_num;
var random_x;
var Nc = 0;
var play_num = 0;
var mouse = new THREE.Vector2(), intersects;
var AudioBuffer;
var DATA;
var vmdIndex;
var container;
var objects = [];
// var plane = new THREE.Plane();
var raycaster;
var offset = new THREE.Vector3();
var intersection = new THREE.Vector3(),INTERSECTED, SELECTED;
var Sound_num = 0;
var messages =  [
		"I can speek japanese a little.",
		"May I help you?",
		"わたしのゴーストがささやくのよ。",
		"どうした？　だれかいるのか？",
		"私と議論しないか？",
		"まだ、オンライン中だ。",
		"要件はそれだけか？",
		"そろそろ、睡眠をとる時間だ。",
		"あなたに会えてよかった",
		"変なことするんじゃない！",
		"どうした？",
		"あははは！",
		"あーあ、あっきれた！",
		"涙がとまらないの",
		"貴様は許さない！",
		"あーっはははは！",
		"それは、本当か？",
		"今、何をしているのだ。",
		"おはようございます",
		"じろじろ見るんじゃない",
		];

var	nameFiles = [
		'草薙素子',
		'メイコさん',
		'TDAミク',
		'黒ｺｰﾄの素子',
		'光学迷彩素子',
		'あきね',
		'エレナ',
	];

var	pmdFiles = [
		'mmd/miku/motoko3/motoko1.pmx',
		'mmd/miku/MEIKO3/meiko3.pmx',
		'mmd/miku/miku-tda/miku-tda1.pmx',
		'mmd/miku/motoko3/motoko4.pmx',
		'mmd/miku/motoko2/motoko3.pmx',
		'mmd/miku/akine/akine.pmd',
		'mmd/miku/elena/elena.pmd',
	];

var	nameFiles2 = [
		'考え中',
		'歩く',
		'走る',
		'バクテン',
		'えっへへ',
		'左フック',
		'防御１',
		'防御２',
		'左ストレート',
		'なんだろう？',
		'ワォ！',
		'ほんとに？',
		'ポン！',
		'キッス',
		'笑う',
		'ハイキック',
	];

var	vmdFiles2 = [
		'mmd/vmd/notice.vmd',
		'mmd/vmd/walk.vmd',
		'mmd/vmd/run.vmd',
		'mmd/vmd/backroll.vmd',
		'mmd/vmd/Eheee.vmd',
		'mmd/vmd/Fuck_L.vmd',
		'mmd/vmd/guard.vmd',
		'mmd/vmd/guard2.vmd',
		'mmd/vmd/Punch_L.vmd',
		'mmd/vmd/whatis.vmd',
		'mmd/vmd/Waoh.vmd',
		'mmd/vmd/realy.vmd',
		'mmd/vmd/Pon.vmd',
		'mmd/vmd/kiss.vmd',
		'mmd/vmd/laugh.vmd',
		'mmd/vmd/rollkick.vmd',
		'mmd/vmd/kick_R_H.vmd',
		'mmd/vmd/JAB_R_H.vmd',
	//	'mmd/vmd/sleepy.vmd',
	//	'mmd/vmd/morning.vmd',
	//	'mmd/vmd/bang.vmd',
	//	'mmd/vmd/biku.vmd',
	//	'mmd/vmd/dance2.vmd',
	//	'mmd/vmd/dance1.vmd',
	//	'mmd/vmd/base.vmd',
	//	'mmd/vmd/kick_R_K.vmd',
	//	'mmd/vmd/kick_L_M.vmd',
	];

var	F_stop = 0;
var	F_walk = 0;
var	F_run  = 0;
var	F_song = 0;
var	Reset = 0;

var	nameFiles3 = [
		'ﾊｲﾌｧｲﾚｲﾊﾞｰ',
		'ﾋﾟﾋﾟﾋﾟﾀｯﾁ',
		'ﾈｺﾐﾐｽｲｯﾁ',
		'深海少女',
		'ｻｲﾊﾞｻｲﾀﾞｾｲﾊﾞ',
	];

var	nameFiles4 = [
		'RV-6A',
		'MRJ90',
		'YS11',
		'F2A',
		'Rider',
		'Ki-61 HIEN',
		'2000GT',
		'240Z',
		'Tachikoma',
		'GTR',
		'Match5',
	];

var Song_BTN_No;
var F_nouseAudio = 0;
//
var	ViewMode = [
		'Look At',
		'CloseUP',
		'Chase',
		'Far',
		'Walk',
	];

/*************************************/
//Web Audio API
/*************************************/
var context;
var context2;
var bufferLoader;
var playsound;

window.AudioContext = window.AudioContext || window.webkitAudioContext;

function Sound(n) {
	playsound = playSound(bufferLoader.bufferList[n], 3 );
}

function playSound(buffer, time) {
	var source = context.createBufferSource();
	source.buffer = buffer;
	source.loop = false;
	source.connect(context.destination);
	source.start(time);
	return source;
}

var data2buffer = function( dataURI ) {  
	var byteString = atob( dataURI.split(',')[1]);
	var len = byteString.length;
	var buffer = new Uint8Array(len);
	for (var i=0; i<len; ++i) {
		buffer[i] = byteString.charCodeAt(i);
	}
	return buffer.buffer;
};

/*************************************/
//cookie読み込み
/*************************************/
/*
if ($.cookie("name")) {
	$("#labelName").val($.cookie("name"));
} else {
	$("#labelName").val("zero1962");
}
*/
	$("#labelName").val("You");
/*************************************/
//人工無脳エクサにPOST
/*************************************/
var voice_flag = true; //音声出力ON/OFFフラグ
var name_flag = true; //名前入力ありなしフラグ
var kaiwa_flag = false; //発言入力ありなしフラグ

//発言入力のfocus,blur
$("#labelKaiwa").focus(function() {
	if ($(this).val() == "発言") {
		$(this).css("color","#000");
		$(this).val("");
	}
});
$("#labelKaiwa").blur(function() {
	if ($(this).val() == "") {
		$(this).css("color","#ccc");
		$(this).val("発言");
	}
});

var cutFigure = "1024"; //表示を14文字に制限
var afterTxt = " …"; //末尾に省略表示

$("#btn").click(function() {
	//発言の入力がない場合
	if ($("#labelKaiwa").val() == "発言") {
		$("#labelKaiwa").val("");
		kaiwa_flag = false;
	}
	//連続POST禁止
	if ($("#labelKaiwa").val() == "") {
		return false;
	}
	//発言の入力があった場合
	if ($("#labelKaiwa").val()) {
		//文字数制限
		hatsugen = $("#labelKaiwa").val();
		textLength = hatsugen.length;
		textTrim = hatsugen.substr(0,(cutFigure));
		if (cutFigure < textLength) {
			hatsugen = textTrim + afterTxt;
		}
		if ( Menu.Word == true )
		{
			random_x = Math.round( Math.random()*50 )*1.1;
setTimeout(function() {	$(".align_bottom").before("<div class='align_left' style='padding-left:" + random_x + "px;'><span class='you_say'>" + hatsugen + "</span></div>");}, 0);
			var position = $("#henji div:last-child").offset().top - 0;
			$("#scrollarea").animate({scrollTop: position},"slow");
		}
		kaiwa_flag = true;
// alert(hatsugen);
	}
	var data = {
		name: $("#labelName").val(),
		kaiwa: $("#labelKaiwa").val(),
	//	btn: $("#btn").val(),
	//	_encodingHint: $("#_encodingHint").val()
	};
	$.ajax({
		type: "POST",
		url: "exa.cgi",
		data: data,
		success: function(data) {
alert(data);
			//	console.log(data);
				if (name_flag || kaiwa_flag) {
					//文字数制限
					textLength = data.length;
					textTrim = data.substr(0,(cutFigure));
					if (cutFigure < textLength) {
						data = textTrim + afterTxt;
					}
					if ( Menu.Word == true )
					{
						random_x = Math.round( Math.random()*50 )*1.1;
setTimeout(function() {	$(".align_bottom").before("<div class='align_left' style='padding-left:" + random_x + "px;'><span class='brain_say'>" + data + "</span></div>");}, 0);
						var position = $("#henji div:last-child").offset().top - 0;
						$("#scrollarea").animate({scrollTop: position},"slow");
					}
					if ( Menu.Voice == true ){ playVoice("ja", data ) }
				}
				//表情(気持ち)切り替え
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
			}
	});
	
	//リターン連続入力フォーカス用
	if ($("#labelKaiwa").val()) {
		$("#labelKaiwa").val("");
setTimeout(function() {	$("#labelKaiwa").focus();}, 0);
	}
	return false;
});

/*************************************/
//rospeexにPOST
/*************************************/

/*
var voicetra_url = "http://rospeex.ucri.jgn-x.jp/nauth_json/jsServices/VoiceTraSS";
var selected_language = "ja";

function playVoice(language, message) {
	$.ajax({
		url: voicetra_url,
		data: {
			method: "speak",
			params: [language, message, "*", "audio/x-wav"]
		},
		dataType: "jsonp",
		jsonp: "callback",
		cache: false,
		success: function(data) {
				console.log(data);
				if (data["error"] == null) {
					audio = new Audio("data:audio/mpeg;base64," + data["result"]["audio"]);
					audio.play();
				//	DATA = 'data:audio/mp3;base64,' + data["result"]["audio"];
				}
		},
		error: function(XMLHttpRequest, status, errorThrown) {
			console.log(status);
			console.log(errorThrown);
			console.log(XMLHttpRequest);
		},
		complete: function(XMLHttpRequest, status) {
			if (status != "success") {
				console.log("Voicetra Server Error : ", status);
			}
		}
	});
//	context2.decodeAudioData( data2buffer( DATA ), function(buffer) {
//		AudioBuffer = buffer;
//	});
//	playSound(AudioBuffer, 0);
};
*/


function playVoice(language, message) {
	var speech = new SpeechSynthesisUtterance();
	speech.voiceURI = 'Google 日本人';
	speech.lang     = 'ja-JP';
	speech.rate     = 1.2;
	speech.volume   = 0.8;
	speech.pitch    = 1.7;
	speech.text     = message;
	speechSynthesis.speak(speech);
}

/*************************************/
//ローディングアイコン
/*************************************/
var spinner = null;
var spintarget = null;

function spinPreparation() {
		var opts = {
		lines: 25, 	// The number of lines to draw
		length: 100, 	// The length of each line
		width: 10,	// The line thickness
		radius: 70, 	// The radius of the inner circle
		corners: 1, 	// Corner roundness (0..1)
		rotate: 0, 	// The rotation offset
		direction: 1, 	// 1: clockwise, -1: counterclockwise
		color: "#2f2", 	// #rgb or #rrggbb or array of colors
		speed: 1, 	// Rounds per second
		trail: 60, 	// Afterglow percentage
		shadow: false, 	// Whether to render a shadow
		hwaccel: false, // Whether to use hardware acceleration
		className: "spinner", // The CSS class to assign to the spinner
		zIndex: 100, 	// The z-index (defaults to 2000000000)
		top: "50%", 	// Top position relative to parent
		left: "50%", 	// Left position relative to parent
		};
		spintarget = document.getElementById("spin_icon");
		spinner = new Spinner(opts);
};
/*************************************/
//userAgent
/*************************************/
	var ua = {};
	ua.name = window.navigator.userAgent.toLowerCase();
	ua.isIE = (ua.name.indexOf("msie") >= 0 || ua.name.indexOf("trident") >= 0);
	ua.isiPhone = ua.name.indexOf("iphone") >= 0;
	ua.isiPod = ua.name.indexOf("ipod") >= 0;
	ua.isiPad = ua.name.indexOf("ipad") >= 0;
	ua.isiOS = (ua.isiPhone || ua.isiPod || ua.isiPad);
	ua.isAndroid = ua.name.indexOf("android") >= 0;
	ua.isTablet = (ua.isiPad || (ua.isAndroid && ua.name.indexOf("mobile") < 0));
	ua.isChrome = ua.name.indexOf("chrome") != -1;
	
	if (!ua.isIE && !ua.isiOS && !ua.isTablet) {
		;
	}
	if (ua.isIE) {
alert("IEはAudioサポートありません！");
		F_nouseAudio = 1;
	}
	//スマホ・タブレット用
//	if (ua.isiOS || ua.isAndroid || ua.isTablet) {
//		location.href = "index-i.html";
//	}
	if (ua.isChrome) {
		;
	}
	if (ua.isiPhone) {
		alert("iPhoneの場合Songsを読み込めない場合があります。");
	}

if( F_nouseAudio == 0 )
{
	context  = new AudioContext();
	context2 = new AudioContext();
}

/*************************************/
//カーソル形状
/*************************************/

$("#container").mousedown(function() {
	$("#container").addClass("grabbing");
	$("#container").removeClass("grab");
});
$("#container").mouseup(function() {
	$("#container").addClass("grab");
	$("#container").removeClass("grabbing");
});

/*------------------------------------------------------------------------------
JavaScript  関数構成
------------------------------------------------------------------------------*/
init(); // 初期化処理

THREE.DefaultLoadingManager.onProgress = function() {
	$(".spinner").fadeOut(1200, function() {
		$(".spinner").remove();
		$("#spin_icon").remove();
		$("#control").animate({opacity: "1.0"},100);
	});
};
loop(); // 周期処理

/*------------------------------------------------------------------------------
JavaScript  初期化処理
------------------------------------------------------------------------------*/
function init() {
	document.getElementById('canvas-frame').appendChild ( renderer.domElement );
	container = document.getElementById( 'container' );
	raycaster = new THREE.Raycaster();

// Rendering
	renderer.setSize       ( SCREEN_WIDTH, SCREEN_HEIGHT );
	renderer.setClearColor ( 'rgb(0,150,255)' );
	renderer.setPixelRatio ( window.devicePixelRatio );

// Drop Shadow
	renderer.shadowMap.renderReverseSided = true;
	renderer.shadowMapEnabled = true;
	renderer.shadowMap.type = THREE.PCFShadowMap;

// EVENTS
	document.addEventListener( 'keydown', onKeyDown, false );
	window.addEventListener( 'resize' , onWindowResize, false );
	onWindowResize();

// Add Sky Mesh
	sky = new THREE.Sky();
	scene.add( sky.mesh );

// Add Sun Helper
	sunSphere = new THREE.Mesh(
		new THREE.SphereBufferGeometry( 20, 16, 8 ),
		new THREE.MeshBasicMaterial( { color: 0xffffff } )
	);
	var distance                   =  9250;
	var uniforms                   = sky.uniforms;

	uniforms.turbidity.value       = 10;
	uniforms.reileigh.value        = 1;
	uniforms.luminance.value       = 1;
	uniforms.mieCoefficient.value  = 0.005;
	uniforms.mieDirectionalG.value = 0.8;

	var theta =     Math.PI * ( -0.15 - 0.5 );  // elevation / inclination   0.49 夜明け
	var phi   = 2 * Math.PI * (  0.17 - 0.5 );  // Facing front              0.25
	sunSphere.position.x = distance * Math.cos( phi );
	sunSphere.position.y = distance * Math.sin( phi ) * Math.sin( theta );
	sunSphere.position.z = distance * Math.sin( phi ) * Math.cos( theta );
	sunSphere.visible    = true;
	sky.uniforms.sunPosition.value.copy( sunSphere.position );
	scene.add( sunSphere );

// Light
var	ambient = new THREE.AmbientLight( 0x444444 ,1.5 );
	scene.add( ambient );
	sunLight.position.x = sunSphere.position.x;
	sunLight.position.y = sunSphere.position.y;
	sunLight.position.z = sunSphere.position.z;
	sunLight.lookAt( scene.position );
// Shadow
	sunLight.castShadow = true;
	sunLight.shadow = new THREE.LightShadow( new THREE.PerspectiveCamera( 50, 1, 1200, 1000 ) );
	sunLight.shadow.bias = 0.0001;
	sunLight.shadow.camera.near = 500;
	sunLight.shadow.camera.far = 2000;
	sunLight.shadow.camera.top = 40;
	sunLight.shadow.camera.bottom = -40;
	sunLight.shadow.camera.left = 40;
	sunLight.shadow.camera.right = -40;
	sunLight.shadow.mapSize.width = SHADOW_MAP_WIDTH;
	sunLight.shadow.mapSize.height = SHADOW_MAP_HEIGHT;

	scene.add( sunLight );

// GROUND
var	groundGeometry = new THREE.BoxGeometry(  24, 0.01, 800 );
var	LineGeometry  = new THREE.BoxGeometry( 0.3, 0.01, 700 );
var	groundMaterial = new THREE.MeshLambertMaterial( { color: 'rgb(100,100,100)' } );
var	WLineMaterial   = new THREE.MeshLambertMaterial( { color: 'rgb(255,255,255)' } );
var	YLineMaterial   = new THREE.MeshLambertMaterial( { color: 'rgb(255,255,0  )' } );
var	CLineMesh  = new THREE.Mesh( LineGeometry, WLineMaterial );
var	LLineMesh  = new THREE.Mesh( LineGeometry, YLineMaterial );
var	RLineMesh  = new THREE.Mesh( LineGeometry, YLineMaterial );
	LLineMesh.position.x = -11;
	RLineMesh.position.x =  11;
	groundMesh = new THREE.Mesh( groundGeometry, groundMaterial );
	groundMesh.add(CLineMesh);
	groundMesh.add(LLineMesh);
	groundMesh.add(RLineMesh);
	groundMesh.position.z = -300;
	groundMesh.position.y = 0.02;
	groundMesh.scale.set( 5, 5, 5 );
	groundMesh.castShadow = true;
	groundMesh.receiveShadow = true;
	scene.add( groundMesh );
	
var 	GreenGeometry = new THREE.BoxGeometry( 300, 0.01, 850 );
var 	GreenMaterial = new THREE.MeshLambertMaterial( { color: 'rgb( 80, 160, 20)' } );  // Kd 0.009600 0.210400 0.097600
	GreenMesh = new THREE.Mesh( GreenGeometry, GreenMaterial );
	GreenMesh.position.x =  50;
	GreenMesh.position.y = 0.01;
	GreenMesh.position.z = -280;
var	GreenNormals = new THREE.TextureLoader().load( 'textures/terrain/grasslight-big.jpg' );
	GreenNormals.wrapS = GreenNormals.wrapT = THREE.RepeatWrapping;
	GreenNormals.repeat.set( 40, 40 );
	GreenMesh.material.map = GreenNormals;
	GreenMesh.material.needsUpdate = true;
	GreenMesh.castShadow = true;
	GreenMesh.receiveShadow = true;
	GreenMesh.scale.set( 5, 5, 5 );
	scene.add( GreenMesh );

var 	SeaGeometry = new THREE.BoxGeometry( 10000, 0.01, 10000 );
// var 	SeaMaterial = new THREE.MeshLambertMaterial( { color: 'rgb(0,50,150)' } );
var 	SeaMaterial = new THREE.MeshLambertMaterial( { color: 0xffffff } );
	SeaMesh = new THREE.Mesh( SeaGeometry, SeaMaterial );
	SeaMesh.position.y = -0.5;
var	waterNormals = new THREE.TextureLoader().load( 'textures/waternormals.jpg' );
	waterNormals.wrapS = waterNormals.wrapT = THREE.RepeatWrapping;
	waterNormals.repeat.set( 50, 50 );
	SeaMesh.material.map = waterNormals;
	SeaMesh.material.needsUpdate = true;
	SeaMesh.castShadow = true;
	SeaMesh.receiveShadow = true;
	SeaMesh.scale.set( 5, 5, 5 );
	scene.add( SeaMesh );

//GridHelper作成
	grid = new THREE.GridHelper(100, 100);
	grid.material.color = new THREE.Color( 0x00cccc);
//	scene.add(grid);

//AxisHelper作成
	axis_n = new THREE.AxisHelper(100);
//	scene.add(axis_n);
	axis_v = new THREE.AxisHelper(10);
	var Qaxis = axis_v.quaternion;
//	scene.add(axis_v);

// helper
	var directionalLightHelper = new THREE.DirectionalLightHelper(sunLight);
	scene.add( directionalLightHelper);
	directionalLightShadowHelper = new THREE.CameraHelper( sunLight.shadow.camera);
//	scene.add( directionalLightShadowHelper);


// オブジェ
var	hanger_vertices = [
				-10,   0,  -10,
				-10,  10,  -10,
				  0,  15,  -10,
				 10,  10,  -10,
				 10,   0,  -10,
				-10,  10,   10,
				-10,   0,   10,
				 10,   0,   10,
				 10,  10,   10,
				  0,  15,   10,
				 -5,   0,   10,
				  5,   0,   10,
				 -5,  10,   10,
				  5,  10,   10,
			];

var	hanger_Faces = [
				 0, 3, 1,
				 0, 1, 3,
				 0, 3, 4,
				 0, 4, 3,
				 1, 2, 3,
				 1, 3, 2,
				 0, 5, 1,
				 0, 1, 5,
				 0, 5, 6,
				 0, 6, 5,
				 4, 3, 8,
				 4, 8, 3,
				 4, 8, 7,
				 4, 7, 8,
				 1, 2, 9,
				 1, 9, 2,
				 1, 5, 9,
				 1, 9, 5,
				 2, 9, 3,
				 2, 3, 9,
				 9, 8, 3,
				 9, 3, 8,
				 9, 8, 5,
				 9, 5, 8,
				12, 6, 10,
				12, 10, 6,
				12, 5, 6,
				12, 6, 5,
				13, 8, 7,
				13, 7, 8,
				13,11, 7,
				13, 7,11,
			];
// Geometry Object
var	hanger_Geo = new THREE.PolyhedronGeometry ( hanger_vertices, hanger_Faces, 10, 0 );
var	hanger_Mat = new THREE.MeshLambertMaterial ( { color: 'rgb(100,150, 150)', emissive: 0x000000 } );
	hanger = new THREE.Mesh( hanger_Geo, hanger_Mat );
	hanger.scale.set( 1.5, 1, 1 );
	hanger.position.set(  250, 0,  -10);
	hanger.rotation.set(0, -1.57,   0);
	hanger.scale.set( 5, 5, 5 );
	scene.add( hanger );

// MMD model------------------------------------------------------------------------
	var modelFile = 'mmd/miku/motoko3/motoko1.pmx';

	helper = new THREE.MMDHelper( renderer );
	loader = new THREE.MMDLoader();
	loader.setDefaultTexturePath( 'mmd/default/' );
	loader.loadModel( modelFile, function ( object ) {
		mesh = object;
		mesh.position.y = -10;
		Qbuff = mesh.quaternion;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		mesh.add( camera4 );
		scene.add( mesh );
		helper.add( mesh );

		initGui( mesh );
		ready = true;

// Load vmd
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );

// GUI
	function initGui () {
		var gui = new dat.GUI();
		gui.close();
		var dictionary = mesh.morphTargetDictionary;
		var controls = {};
		var keys = [];
		var setting = gui.addFolder( 'Setting' );
		var models  = gui.addFolder( 'Models'  );
		var motions = gui.addFolder( 'Motions' );
		var songs   = gui.addFolder( 'Songs'   );
		var planes  = gui.addFolder( 'PLANES'  );
		var morphs  = gui.addFolder( 'Morphs'  );
		var help = {};
		help.Help = function () {
			alert('Code @ 2017.12.10 by kuniyuki.tsujimoto');
		};
		gui.add( help, 'Help' ).name( 'HELP' );

		function getBaseName ( s ) {
			return s.slice( s.lastIndexOf( '/' ) + 1 );
		};
		function initControls () {
			for ( var key in dictionary ) {
				controls[ key ] = 0.0;
			}
			controls.model = -1;
			for ( var i = 0; i < nameFiles.length; i++ ) {
				controls[ getBaseName( nameFiles[ i ] ) ] = false;
			}
			controls.motion = -1;
			for ( var i = 0; i < nameFiles2.length; i++ ) {
				controls[ getBaseName( nameFiles2[ i ] ) ] = false;
			}
			controls.songs = -1;
			for ( var i = 0; i < nameFiles3.length; i++ ) {
				controls[ getBaseName( nameFiles3[ i ] ) ] = false;
			}
			controls.planes = -1;
			for ( var i = 0; i < nameFiles4.length; i++ ) {
				controls[ getBaseName( nameFiles4[ i ] ) ] = false;
			}
		};
		function initKeys(){
			for ( var key in dictionary ) {
				keys.push( key );
			}
		};
		function initSetting(){
			Menu.Axis     = false;
			Menu.SkyBox   = false;
			Menu.Skydome  = false;
			Menu.Fuji     = false;
			Menu.Hanger2  = false;
			Menu.SHouse   = false;
			Menu.LogHouse = false;
			Menu.UTAU     = false;
			Menu.UTAU2    = false;
			Menu.Auckland = false;
			Menu.GreenSea = true;
			Menu.Ground   = true;
			Menu.FLD      = false;
			Menu.Demo     = true;
			Menu.Voice    = true;
			Menu.Word     = true;
			Menu.Plane    = false;
			Menu.Speed    = 0.1;
			Menu.Zoom     = 0;
			Menu.Name     = "You";
			setting.add( Menu, 'Axis'     ).onChange( onChangeSetting  );
			setting.add( Menu, 'SkyBox'   ).onChange( onChangeSkyBox   );
			setting.add( Menu, 'Skydome'  ).onChange( onChangeSkydome  );
			setting.add( Menu, 'Fuji'     ).onChange( onChangeFuji     );
			setting.add( Menu, 'Hanger2'  ).onChange( onChangeHanger2  );
			setting.add( Menu, 'SHouse'   ).onChange( onChangeSHouse   );
			setting.add( Menu, 'LogHouse' ).onChange( onChangeLogHouse );
			setting.add( Menu, 'UTAU'     ).onChange( onChangeUTAU     );
			setting.add( Menu, 'UTAU2'    ).onChange( onChangeUTAU2    );
			setting.add( Menu, 'Auckland' ).onChange( onChangeAuckland );
			setting.add( Menu, 'GreenSea' ).onChange( onChangeSetting  );
			setting.add( Menu, 'Ground'   ).onChange( onChangeSetting  );
			setting.add( Menu, 'FLD'      ).onChange( onChangeFLD      );
			setting.add( Menu, 'Demo'     ).onChange( onChangeSetting  );
			setting.add( Menu, 'Voice'    ).onChange( onChangeSetting  );
			setting.add( Menu, 'Word'     ).onChange( onChangeSetting  );
			setting.add( Menu, 'Speed', -10, 10 );
			setting.add( Menu, 'Zoom',  -100, 100 );
			setting.add( Menu, 'Name',  "You" ).onChange( onChangeName );
		};
		function initModels(){
			var files = { default: -1 };
			for ( var i = 0; i < nameFiles.length; i++ ) {
				files[ getBaseName( nameFiles[ i ] ) ] = i;
			}
			models.add( controls, 'model', files ).onChange( onChangeModel );
		};
		function initMotions(){
			var files = { default: -1 };
			for ( var i = 0; i < nameFiles2.length; i++ ) {
				files[ getBaseName( nameFiles2[ i ] ) ] = i;
			}
			motions.add( controls, 'motion', files ).onChange( onChangeMotion );
		};
		function initSongs(){
			var files = { default: -1 };
			for ( var i = 0; i < nameFiles3.length; i++ ) {
				files[ getBaseName( nameFiles3[ i ] ) ] = i;
			}
			songs.add( controls, 'songs', files ).onChange( onChangeSongs );
		};
		function initPlanes(){
			var files = { default: -1 };
			for ( var i = 0; i < nameFiles4.length; i++ ) {
				files[ getBaseName( nameFiles4[ i ] ) ] = i;
			}
			planes.add( controls, 'planes', files ).onChange( onChangePlanes );
		};
		function initMorphs(){
			for ( var key in dictionary ) {
				morphs.add( controls, key, 0.0, 1.0, 0.01 ).onChange( onChangeMorph );
			}
		};
		function onChangeSetting(){
			// 地形、メッシュ、座標軸　表示設定
			if( !Menu.Ground )
			{
				scene.remove( groundMesh );
			}
			else
			{
				scene.add( groundMesh );
			}
			
			if( !Menu.GreenSea )
			{
				scene.remove( hanger    );
				scene.remove( GreenMesh );
				scene.remove( SeaMesh   );
			}
			else
			{
				scene.add( hanger    );
				scene.add( GreenMesh );
				scene.add( SeaMesh   );
			}
			
			if( !Menu.Axis )
			{
				scene.remove( axis_n );
				scene.remove( axis_v );
				scene.remove( directionalLightShadowHelper);
				scene.remove( grid );
			}
			else
			{
				scene.add( axis_n );
				scene.add( axis_v );
				scene.add( directionalLightShadowHelper);
				scene.add( grid );
			}
		};
		
		function onChangeSkyBox(){
			if( Menu.SkyBox )
			{
				// load skybox
var				cubeMap = new THREE.CubeTexture( [] );
				cubeMap.format = THREE.RGBFormat;
var				loader = new THREE.ImageLoader();
				loader.load( 'textures/skyboxsun25degtest.png', function ( image ) {
var					getSide = function ( x, y ) {
						var size = 1024;
						var canvas = document.createElement( 'canvas' );
						canvas.width = size;
						canvas.height = size;
						var context = canvas.getContext( '2d' );
						context.drawImage( image, - x * size, - y * size );
						return canvas;
					};
					cubeMap.images[ 0 ] = getSide( 2, 1 ); // px
					cubeMap.images[ 1 ] = getSide( 0, 1 ); // nx
					cubeMap.images[ 2 ] = getSide( 1, 0 ); // py
					cubeMap.images[ 3 ] = getSide( 1, 2 ); // ny
					cubeMap.images[ 4 ] = getSide( 1, 1 ); // pz
					cubeMap.images[ 5 ] = getSide( 3, 1 ); // nz
					cubeMap.needsUpdate = true;
				} );
				var cubeShader = THREE.ShaderLib[ 'cube' ];
				cubeShader.uniforms[ 'tCube' ].value = cubeMap;
				var skyBoxMaterial = new THREE.ShaderMaterial( {
					fragmentShader: cubeShader.fragmentShader,
					vertexShader: cubeShader.vertexShader,
					uniforms: cubeShader.uniforms,
					depthWrite: false,
					side: THREE.BackSide
				} );
				skyBox = new THREE.Mesh(
					new THREE.BoxGeometry( 500000, 500000, 500000 ),
					skyBoxMaterial
				);
				scene.add( skyBox );
			}
			else
			{
				scene.remove( skyBox );
			}
		};
		
		function onChangeSkydome(){
			if( Menu.Skydome )
			{
				loader.loadModel( 'mmd/Skydome/Dome_X501.pmx', function ( object ) {
					object.scale.set( 10, 10, 10 );
					Skydome.add( object );
					Skydome.position.set( 0, 0,  -900 );
					scene.add( Skydome );
				}, null, null );
			}
			else
			{
				scene.remove( Skydome );
			}
		};
		
		function onChangeFLD(){
			if( Menu.FLD )
			{// Stage 神戸
				mtlLoader.load( 'kobe.mtl', function( materials ) {
					materials.preload();
					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'kobe.obj', function ( object ) {
						object.scale.set( 1.5, 1.5, 1.5 );
						object.position.set( 7550, 0, -6500 );
						object.rotation.set( 0, 1.48, 0 );
						FLD = object;
						scene.add( FLD );
					}, null, null );
				});
			}
			else
			{
				scene.remove( FLD );
			}
		};
		
		function onChangeFuji(){
			if( Menu.Fuji )
			{
				loader.loadModel( 'mmd/Fuji/Fujisan.pmx', function ( object ) {
					object.scale.set( 10, 10, 10 );
					Fuji.add( object );
					Fuji.position.set( 0, 0, -900 );
					scene.add( Fuji );
				}, null, null );
			}
			else
			{
				scene.remove( Fuji   );
			}
		};
		
		function onChangeAuckland(){
			if( Menu.Auckland )
			{
				loader.loadModel( 'mmd/Auckland/Auckland.pmx', function ( object ) {
					object.scale.set( 1, 1, 1 );
					Auckland.add( object );
					Auckland.position.set( 13000, 0,  -200 );
					Auckland.castShadow = true;
					Auckland.receiveShadow = true;
					scene.add( Auckland );
				}, null, null );
			}
			else
			{
				scene.remove( Auckland );
			}
		};
		
		function onChangeHanger2(){
			if( Menu.Hanger2 )
			{
				loader.loadModel( 'mmd/Hanger2/Hanger2.pmx', function ( object ) {
					object.scale.set( 0.2, 0.2, 0.2 );
					Hanger2.add( object );
					Hanger2.rotation.set( 0, 1.57,     0 );
					Hanger2.position.set( 180, 0,  150 );
					scene.add( Hanger2 );
				}, null, null );
			}
			else
			{
				scene.remove( Hanger2   );
			}
		};
		
		function onChangeSHouse(){
			if( Menu.SHouse )
			{
				loader.loadModel( 'mmd/Shouse/Fense.pmx', function ( object ) {
					Fense.add( object );
				//	Fense.rotation.set( 0, 1.57,     0 );
					Fense.position.set( 180, 0,  -300 );
					scene.add( Fense );
				}, null, null );
				loader.loadModel( 'mmd/Shouse/Shouse.pmx', function ( object ) {
					SHouse.add( object );
				//	SHouse.rotation.set( 0, 1.57,     0 );
					SHouse.position.set( 180, 0,  -300 );
					scene.add( SHouse );
				}, null, null );
			}
			else
			{
				scene.remove( Fense   );
				scene.remove( SHouse   );
			}
		};
		
		function onChangeLogHouse(){
			if( Menu.LogHouse )
			{
				loader.loadModel( 'mmd/loghouse/loghouse.pmx', function ( object ) {
					LogHouse.add( object );
					LogHouse.rotation.set( 0, 3.14,     0 );
					LogHouse.position.set( -180, 0,  0 );
					scene.add( LogHouse );
				}, null, null );
			}
			else
			{
				scene.remove( LogHouse   );
			}
		};
		
		function onChangeUTAU(){
			if( Menu.UTAU )
			{
				loader.loadModel( 'mmd/UTAU/UTAU.pmx', function ( object ) {
					UTAU.add( object );
					UTAU.position.set( -180, 0,  -300 );
					scene.add( UTAU );
				}, null, null );
			}
			else
			{
				scene.remove( UTAU   );
			}
		};
		
		function onChangeUTAU2(){
			if( Menu.UTAU2 )
			{
				loader.loadModel( 'mmd/UTAU/UTAU1F.pmx', function ( object ) {
					UTAU1F.add( object );
					UTAU1F.position.set( -180, 0,  -300 );
					scene.add( UTAU1F );
				}, null, null );
				loader.loadModel( 'mmd/UTAU/UTAU2F.pmx', function ( object ) {
					UTAU2F.add( object );
					UTAU2F.position.set( -180, 0,  -300 );
					scene.add( UTAU2F );
				}, null, null );
				loader.loadModel( 'mmd/UTAU/UTAU3F.pmx', function ( object ) {
					UTAU3F.add( object );
					UTAU3F.position.set( -180, 0,  -300 );
					scene.add( UTAU3F );
				}, null, null );
				loader.loadModel( 'mmd/UTAU/UTAU_1F.pmx', function ( object ) {
					UTAU_1F.add( object );
					UTAU_1F.position.set( -180, 0,  -300 );
					scene.add( UTAU_1F );
				}, null, null );
				loader.loadModel( 'mmd/UTAU/UTAU_E.pmx', function ( object ) {
					UTAU_E.add( object );
					UTAU_E.position.set( -180, 0,  -300 );
					scene.add( UTAU_E );
				}, null, null );
			}
			else
			{
				scene.remove( UTAU1F );
				scene.remove( UTAU2F );
				scene.remove( UTAU3F );
				scene.remove( UTAU_1F );
				scene.remove( UTAU_E );
			}
		};
		
		function onChangeName(){
			$("#labelName").val(Menu.Name);
		};
		
		function onChangeModel(){
			var index = parseInt( controls.model );
			if ( index === -1 ) {
				mesh.model();
			} else {
				ObjectLoad( index );
				Who_BTN_No = index;
			}
		};
		
		function onChangeMotion(){
			var index = parseInt( controls.motion );
			if ( index === -1 ) {
				mesh.motion();
			} else {
                	        mesh.mixer.stopAllAction();
				clip = mesh.geometry.animations[index * 2];
				action = mesh.mixer.clipAction(clip);
				action.repetitions = 0;
				action.play();
				action.reset();
			}
		};
		
		function onChangeSongs(){
			var index = parseInt( controls.songs );
			if ( index === -1 ) {
				mesh.songs();
			} else {
				SongsLoad( index );
			}
		};
		
		function onChangePlanes(){
			if( V.z == 0 )
			{
				P.x = 0;
				P.y = 15;
				P.z = -150;
			}
			Menu.Plane = true;
			Menu.Demo = false;
			mesh.mixer.stopAllAction();
			scene.remove( mesh );
			var index = parseInt( controls.planes );
			
			
			Plane_No = index;
			if ( index == 0 )
			{ // RV-6A
				mtlLoader.load( 'prop_RV6A.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'prop_RV6A.obj', function ( object ) {
						RV6A_propMesh = object;
					}, null, null );
				});
				
				mtlLoader.load( 'rv6a.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'rv6a.obj', function ( object ) {
						object.scale.set( 11, 11, 11 );
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer1 = object;
						Buffer1.add( Cockpit );
						Buffer1.add( RV6A_propMesh );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
						scene.add( Plane );
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,   12, -8 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( -2,   -6, 0 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );

				}, null, null );
				
			}
			else if( index == 1 )
			{ // MRJ90
				mtlLoader.load( 'mrj90.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'mrj90.obj', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer3 = object;
						Buffer3.scale.set( 0.78,  0.78,  0.78 );
						Buffer3.position.set( 0, 10, 0 );
						Plane2.add( Buffer3 );
						Qbuff2 = Plane2.quaternion;
						scene.add( Plane2 );
					}, null, null );
				});
				
				mtlLoader.load( 'mrj90F.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'mrj90F.obj', function ( object ) {
						Buffer1 = object;
						Buffer1.scale.set(  0.78,  0.78,  0.78 );
						Buffer1.position.set( 0,  10, 0 );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( -5, 11, -20 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( -5,  6, -131 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if( index == 2 )
			{ // YS11
				Plane.remove( Buffer1 );
				scene.remove( Plane );
				mtlLoader.load( 'propYS11.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'propYS11.obj', function ( object ) {
						object.scale.set(  10, 10, 10  );
						object.position.set( 43, -2, -39);
						YS11R_propMesh = object;
					}, null, null );
				});
				
				mtlLoader.load( 'propYS11.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'propYS11.obj', function ( object ) {
						object.scale.set(  10, 10, 10  );
						object.position.set( -43, -2, -39);
						YS11L_propMesh = object;
					}, null, null );
				});
				
				mtlLoader.load( 'YS11-F.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'YS11-F.obj', function ( object ) {
						object.scale.set( 0.8, 0.8, 0.8 );
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer1 = object;
						Buffer1.add( YS11R_propMesh );
						Buffer1.add( YS11L_propMesh );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
						scene.add( Plane );
					}, null, null );
				});
				mtlLoader.load( 'GearYS11.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'GearYS11.obj', function ( object ) {
						YS11_Gear = object;
						YS11_Gear.scale.set( 0.8, 0.8, 0.8 );
						Q_Gear = YS11_Gear.quaternion;
						scene.add( YS11_Gear );
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  12, -15 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( -3,  -2, -60 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if( index == 3 )
			{ // F2A
				mtlLoader.load( 'F2-525.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'F2-525.obj', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer3 = object;
						Buffer3.scale.set( 1,  1,  1 );
						Buffer3.position.set( 0, 10, 0 );
						Plane2.add( Buffer3 );
						Qbuff2 = Plane2.quaternion;
						scene.add( Plane2 );
					}, null, null );
				});
				
				mtlLoader.load( 'F2-525-F.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'F2-525-F.obj', function ( object ) {
						Buffer1 = object;
						Buffer1.scale.set(  1,  1,  1 );
						Buffer1.position.set( 0,  10, 0 );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  11, -6 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( 0,  8.5, -56 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if( index == 4 )
			{ // Rider
				mtlLoader.load( 'Rider2.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'Rider2.obj', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer1 = object;
						Buffer1.scale.set(  5,  5,  5 );
						Buffer1.position.set( 0,  -2.5, 0 );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/riding.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  14.5, 5 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( 0,  -13.5, 2 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if( index == 5 )
			{ // Ki-61 HIEN
				mtlLoader.load( 'prop_ki61.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'prop_ki61.obj', function ( object ) {
						object.scale.set( 3.32, 3.32, 3.32 );
						object.position.set( 0, 0.28*3.32, -12.7*3.32);
						HIEN_propMesh = object;
					}, null, null );
				});
				mtlLoader.load( 'prop_ki61.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'prop_ki61.obj', function ( object ) {
						object.scale.set( 3.32, 3.32, 3.32 );
						object.position.set( 0, 0.763, -42.5);
						HIEN_propMesh1 = object;
					}, null, null );
				});
				mtlLoader.load( 'prop_ki61.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'prop_ki61.obj', function ( object ) {
						object.scale.set( 1, 1, 1 );
						object.position.set( 0, 0.28, -12.7);
						HIEN_propMesh2 = object;
					}, null, null );
				});
				mtlLoader.load( 'ki61.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'ki61.obj', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer3 = object;
						Buffer3.scale.set( 5,  5,  5 );
						Buffer3.position.set( 0, 15, 0 );
						Buffer3.add( HIEN_propMesh2 );
						Plane2.add( Buffer3 );
						Qbuff2 = Plane2.quaternion;
						scene.add( Plane2 );
					}, null, null );
				});
/*
				mtlLoader.load( 'ki61a.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'ki61a.obj', function ( object ) {
						objs1[1] = object;
						objs1[1].scale.set( 0.15, 0.15, 0.15 );
					}, null, null );
				});
*/
				mtlLoader.load( 'ki61b.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'ki61b.obj', function ( object ) {
						Buffer1 = object;
						Buffer1.scale.set(  1.3,  1.3,  1.3 );
						Buffer1.position.set( 0,  16.5, 0 );
						Buffer1.add( HIEN_propMesh );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  11, -8.5 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( 0,  16, -19 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if ( index == 6 )
			{ // 2000GT
				loader.loadModel( 'mmd/miku/TOYOTA2000GT/TOYOTA2000GT.pmx', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/GearDown2.vpd', function ( vpd ) {
							helper.poseAsVpd( object, vpd );
						}, null, null );
					}
					loadVpd();
					Buffer1 = object;
					Buffer1.rotation.set(  0, 3.14, 0 );
					Buffer1.scale.set( 1.2, 1.2, 1.2 );
					Buffer1.position.set( 0, -15, 0 );
					Plane.add( Buffer1 );
					Qbuff2 = Plane.quaternion;
					scene.add( Plane );
				}, null, null );
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  12, -7 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( 6,  -12, -2 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if ( index == 7 )
			{ // 240Z
				loader.loadModel( 'mmd/miku/F240Z/F240Z.pmx', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/GearDown2.vpd', function ( vpd ) {
							helper.poseAsVpd( object, vpd );
						}, null, null );
					}
					loadVpd();
					Buffer1 = object;
					Buffer1.rotation.set(  0, 3.14, 0 );
					Buffer1.scale.set( 1.2, 1.2, 1.2 );
					Buffer1.position.set( 0, -15, 0 );
					Plane.add( Buffer1 );
					Qbuff2 = Plane.quaternion;
					scene.add( Plane );
				}, null, null );
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  12, -7 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( 6,  -12, -2 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if ( index == 8 )
			{ // Tachikoma
				mtlLoader.load( 'tachikoma.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'tachikoma.obj', function ( object ) {
						object.scale.set( 0.1, 0.1, 0.1 );
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer1 = object;
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
						scene.add( Plane );
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set(  0,   12, -6 );
					object2.rotation.set(  0, 3.14, 0 );
					object2.position.set(  0,   -1, 6 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if( index == 9 )
			{ // GTR
				mtlLoader.load( 'gtr.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'gtr.obj', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer1 = object;
						Buffer1.scale.set(  1.2,  1.2,  1.2 );
						Buffer1.position.set( 0,  -5, 0 );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  12, -7 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( 6,  -12, -5 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			else if( index == 10 )
			{ // Match5
				mtlLoader.load( 'Mach5.mtl', function( materials ) {
					materials.preload();
					objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.setPath( 'mmd/' );
					objLoader.load( 'Mach5.obj', function ( object ) {
						Plane.remove( Buffer1 );
						scene.remove( Plane );
						Plane2.remove( Buffer3 );
						scene.remove( Plane2 );
						scene.remove(YS11_Gear);
						Buffer1 = object;
						Buffer1.scale.set( 1.8,  1.8,  1.8 );
						Buffer1.position.set( 0,  -7, 0 );
						Plane.add( Buffer1 );
						Qbuff2 = Plane.quaternion;
					}, null, null );
				});
				
				loader.loadModel( pmdFiles[Who_BTN_No], function ( object2 ) {
					var vpdIndex = 0;
					function loadVpd () {
						loader.loadVpd( 'mmd/vpd/drive.vpd', function ( vpd ) {
							helper.poseAsVpd( object2, vpd );
						}, null, null );
					}
					loadVpd();
					camera4.rotation.set(  0, 3.14, 0 );
					camera4.position.set( 0,  10, -7 );
					Pilot.remove( Buffer2 );
					scene.remove( Pilot );
					Buffer2 = object2;
					Buffer2.rotation.set(  0, 3.14, 0 );
					Buffer2.position.set( -6,  -13, -5 );
					Buffer2.add( camera4 );
					Pilot.add( Buffer2 );
					Qbuff3 = Pilot.quaternion;
					scene.add( Pilot );
				}, null, null );
			}
			
			Plane.castShadow = true;
			Plane.receiveShadow = false;
			Plane2.castShadow = true;
			Plane2.receiveShadow = false;
			ready = true;
			
			if( (( Plane_No == 1 )||( Plane_No == 3 )||( Plane_No == 5 )) && ( P.y > 20.0 )  )
			{// MRJ90,F2A,HIEN
				scene.remove( Plane2 );
				scene.add( Plane );
			}
			else
			{// MRJ90,F2A,HIEN
				scene.remove( Plane );
				scene.add( Plane2 );
			}
		};
		
		function onChangeMorph(){
			for ( var i = 0; i < keys.length; i++ ) {
				var key = keys[ i ];
				var value = controls[ key ];
				mesh.morphTargetInfluences[ i ] = value;
			}
		};
		
		initControls();
		initKeys();
		initSetting();
		initModels();
		initMotions();
		initSongs();
		initPlanes();
		initMorphs();
	}
	
	scene.add( camera );
	THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );

// Axis
	axis_v.position.set( 0, 0, 0 );
	axis_v.rotation.set( 0, 0, 0 );

// Camera Window
	camera .position.set(    0,   10,  300 );

	camera0.position.set(    0,   20,  30 );
	camera1.position.set(    0,   17.5,  10 );
	camera2.position.set(  P.x,  P.y,  P.z );
	camera3.position.set(    0,  300,  500 );
	camera4.position.set(    0,   17.5,  10 );

	activeCamera = camera0;

// マウスコントローラー

	controls0 = new THREE.OrbitControls ( camera0,renderer.domElement);
	controls0.maxDistance = 5000;
//	controls0.maxPolarAngle = Math.PI * 0.49;
//	controls0.target.y = 2;
	
	controls3 = new THREE.OrbitControls ( camera3,renderer.domElement);
	controls3.maxDistance = 5000;

	controls1 = new THREE.OrbitControls ( camera1,renderer.domElement );

	controls4 = new THREE.OrbitControls ( camera3,renderer.domElement);
	controls4.maxDistance = 50000;

	scene.add( activeCamera );

// テキスト数値表示 1行目
	var valueDiv = document.createElement( 'div' );
	valueDiv.style.position = 'absolute';
	valueDiv.style.top      = '200px';
	valueDiv.style.right    = '0px';
	valueDiv.style.width    = '300px';
	valueDiv.style.height   = '200px';
	valueDiv.style.fontSize = '15px';
	valueDiv.style.color	= '#FFFF00';
	container.appendChild( valueDiv );
	valueNode  = document.createTextNode( '' );
	valueDiv.appendChild( valueNode );

// テキスト数値表示 2行目
	var valueDiv1 = document.createElement( 'div' );
	valueDiv1.style.position = 'absolute';
	valueDiv1.style.top      = '215px';
	valueDiv1.style.right    = '0px';
	valueDiv1.style.width    = '300px';
	valueDiv1.style.height   = '200px';
	valueDiv1.style.fontSize = '15px';
	valueDiv1.style.color	= '#00FF00';
	container.appendChild( valueDiv1 );
	valueNode1 = document.createTextNode( '' );
	valueDiv1.appendChild( valueNode1 );

// テキスト数値表示 3行目
	var valueDiv2 = document.createElement( 'div' );
	valueDiv2.style.position = 'absolute';
	valueDiv2.style.top      = '230px';
	valueDiv2.style.right    = '0px';
	valueDiv2.style.width    = '300px';
	valueDiv2.style.height   = '200px';
	valueDiv2.style.fontSize = '15px';
	valueDiv2.style.color	= '#00FF00';
	container.appendChild( valueDiv2 );
	valueNode2 = document.createTextNode( '' );
	valueDiv2.appendChild( valueNode2 );

// テキスト数値表示 4行目
	var valueDiv3 = document.createElement( 'div' );
	valueDiv3.style.position = 'absolute';
	valueDiv3.style.top      = '245px';
	valueDiv3.style.right    = '0px';
	valueDiv3.style.width    = '300px';
	valueDiv3.style.height   = '200px';
	valueDiv3.style.fontSize = '15px';
	valueDiv3.style.color	= '#00FF00';
	container.appendChild( valueDiv3 );
	valueNode3 = document.createTextNode( '' );
	valueDiv3.appendChild( valueNode3 );

// Cockpit
	var manager = new THREE.LoadingManager();
	var tex = new THREE.Texture();
	var texLoader = new THREE.ImageLoader( manager );
	
	texLoader.setPath( 'mmd/' );
	texLoader.load( 'rv6a-c.png', function ( image ) {
		tex.image = image;
		tex.needsUpdate = true;
	} );
	var CockpitGeometry = new THREE.BoxGeometry( 0.8, 0.38, 0.01 );
	var CockpitMaterial = new THREE.MeshLambertMaterial ( { color: 'rgb(255,255,255)' } );

	Cockpit = new THREE.Mesh( CockpitGeometry, CockpitMaterial );
	Cockpit.traverse( function ( child ) {
		if ( child instanceof THREE.Mesh ) {
				child.material.map = tex;
		}
	} );
	Cockpit.scale.set(  1,  1,  1 );
	Cockpit.position.set  ( 0, 0.2, -0.005 );

// Set Loader
	var mtlLoader = new THREE.MTLLoader();
	mtlLoader = new THREE.MTLLoader();
	mtlLoader.setPath( 'mmd/' );
}

/*----------------------------------------------------------------------------*/
function ObjectLoad( Model_BTN_No) {

  if( Model_BTN_No == 0 )
  {//草薙素子
	loader.loadModel( 'mmd/miku/motoko2/motoko1.pmx', function ( pmd ) {
		scene.remove( Plane );
		scene.remove( Pilot );
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Model_BTN_No == 1 )
  {//メイコさん
	loader.loadModel( 'mmd/miku/MEIKO3/meiko3.pmx', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Model_BTN_No == 2 )
  {//TDA ミク
	loader.loadModel( 'mmd/miku/miku-tda/miku-tda1.pmx', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Model_BTN_No == 3 )
  {// 黒ｺｰﾄの素子
	loader.loadModel( 'mmd/miku/motoko3/motoko4.pmx', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Model_BTN_No == 4 )
  {// 光学迷彩素子
	loader.loadModel( 'mmd/miku/motoko2/motoko3.pmx', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Model_BTN_No == 5 )
  {// あきね
	loader.loadModel( 'mmd/miku/akine/akine.pmd', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Model_BTN_No == 6 )
  {// エレナ
	loader.loadModel( 'mmd/miku/elena/elena.pmd', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			var vmdFile = vmdFiles2[ vmdIndex ];
			loader.loadVmd( vmdFile, function ( vmd ) {
				loader.createAnimation( mesh, vmd, vmdFiles2[vmdIndex].name);
				vmdIndex++;
				if ( vmdIndex < vmdFiles2.length ) {
					loadvmd();
				} else {
        		                helper.setAnimation( mesh );
	                	        mesh.mixer.stopAllAction();
                        		helper.setPhysics( mesh );
                        		helper.unifyAnimationDuration({afterglow: 1.0});
					clip = mesh.geometry.animations[0];
					action = mesh.mixer.clipAction(clip);
					action.play();
				}
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  mesh.add(camera4);

}

/*----------------------------------------------------------------------------*/
function SongsLoad( NO ) {

	F_song = 1;
	Song_BTN_No = NO;

  if( Song_BTN_No == 0 )
  {// ハイファイレイヴァー
	bufferLoader = new BufferLoader(context, ["mmd/audio/HiFiraver.mp3",],function() {});
	bufferLoader.load();

	
	Menu.Demo   = false;
	loader.loadModel( 'mmd/miku/MEIKO3/meiko3.pmx', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			loader.loadVmd( 'mmd/vmd/HiFiraver.vmd', function ( vmd ) {
				loader.createAnimation( mesh, vmd, 'mmd/vmd/HiFiraver.vmd'.name);
        		        helper.setAnimation( mesh );
	                	mesh.mixer.stopAllAction();
                        	helper.setPhysics( mesh );
                        	helper.unifyAnimationDuration({afterglow: 1.0});
				clip = mesh.geometry.animations[0];
				action = mesh.mixer.clipAction(clip);
			//	action.play();
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Song_BTN_No == 1 )
  {// ピピピタッチ
	bufferLoader = new BufferLoader(context, ["mmd/audio/pipipi.mp3",],function() {});
	bufferLoader.load();
	
	Menu.Demo   = false;
	loader.loadModel( 'mmd/miku/miku-tda/miku-tda1.pmx', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			loader.loadVmd( 'mmd/vmd/dance1.vmd', function ( vmd ) {
				loader.createAnimation( mesh, vmd, 'mmd/vmd/dance1.vmd'.name);
        		        helper.setAnimation( mesh );
	                	mesh.mixer.stopAllAction();
                        	helper.setPhysics( mesh );
                        	helper.unifyAnimationDuration({afterglow: 1.0});
				clip = mesh.geometry.animations[0];
				action = mesh.mixer.clipAction(clip);
			//	action.play();
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Song_BTN_No == 2 )
  {// ねこみみスイッチ
	bufferLoader = new BufferLoader(context, ["mmd/audio/nekomimiswitch.mp3",],function() {});
	bufferLoader.load();
	
	Menu.Demo   = false;
	loader.loadModel( 'mmd/miku/elena/elena.pmd', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			loader.loadVmd( 'mmd/vmd/dance2.vmd', function ( vmd ) {
				loader.createAnimation( mesh, vmd, 'mmd/vmd/dance2.vmd'.name);
        		        helper.setAnimation( mesh );
	                	mesh.mixer.stopAllAction();
                        	helper.setPhysics( mesh );
                        	helper.unifyAnimationDuration({afterglow: 1.0});
				clip = mesh.geometry.animations[0];
				action = mesh.mixer.clipAction(clip);
			//	action.play();
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Song_BTN_No == 3 )
  {// 深海少女
	bufferLoader = new BufferLoader(context, ["mmd/audio/sinkai.mp3",],function() {});
	bufferLoader.load();
	
	Menu.Demo   = false;
	loader.loadModel( 'mmd/miku/akine/akine.pmd', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			loader.loadVmd( 'mmd/vmd/sinkai.vmd', function ( vmd ) {
				loader.createAnimation( mesh, vmd, 'mmd/vmd/sinkai.vmd'.name);
        		        helper.setAnimation( mesh );
	                	mesh.mixer.stopAllAction();
                        	helper.setPhysics( mesh );
                        	helper.unifyAnimationDuration({afterglow: 1.0});
				clip = mesh.geometry.animations[0];
				action = mesh.mixer.clipAction(clip);
			//	action.play();
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
  else if ( Song_BTN_No == 4 )
  {// サイバーサイダーセイバー
	bufferLoader = new BufferLoader(context, ["mmd/audio/SSS.mp3",],function() {});
	bufferLoader.load();
	
	Menu.Demo   = false;
	loader.loadModel( 'mmd/miku/motoko3/motoko1.pmx', function ( pmd ) {
		scene.remove( mesh );
		mesh = pmd;
		mesh.castShadow = true;
		mesh.receiveShadow = false;
		Qbuff = mesh.quaternion;
		helper.add( mesh );
		scene.add( mesh );
		ready = true;
		vmdIndex = 0;
		function loadvmd(){
			loader.loadVmd( 'mmd/vmd/SSS.vmd', function ( vmd ) {
				loader.createAnimation( mesh, vmd, 'mmd/vmd/SSS.vmd'.name);
        		        helper.setAnimation( mesh );
	                	mesh.mixer.stopAllAction();
                        	helper.setPhysics( mesh );
                        	helper.unifyAnimationDuration({afterglow: 1.0});
				clip = mesh.geometry.animations[0];
				action = mesh.mixer.clipAction(clip);
			//	action.play();
			}, null, null );
		};
		loadvmd();
	}, null, null );
  }
alert("Push PD to start!!");
}

/*------------------------------------------------------------------------------
JavaScript  周期処理
------------------------------------------------------------------------------*/
function loop() {
	requestAnimationFrame( loop );
	frameTime = clock.getDelta();
	Time  += frameTime;
	if ( Menu.Demo == true )
	{
		Nc++
		if( Nc > 600 )
		{
			Nc = 0;
			random_num = Math.floor(Math.random()*(vmdFiles2.length-1)+1);
			mesh.mixer.stopAllAction();
			clip = mesh.geometry.animations[random_num];
			action = mesh.mixer.clipAction(clip);
			action.play();

			Sound_num = Math.floor(Math.random()*(messages.length-1)+1);
			if ( Menu.Word == true )
			{
				random_x = Math.round( Math.random()*50 )*1.1;
setTimeout(function() {	$(".align_bottom").before("<div class='align_left' style='padding-left:" + random_x + "px;'><span class='brain_say'>" + messages[Sound_num] + "</span></div>");}, 0);
				var position = $("#henji div:last-child").offset().top - 0;
				$("#scrollarea").animate({scrollTop: position},"slow");
			}
			if ( Menu.Voice == true ){ playVoice("ja", messages[Sound_num]); }
		}
	}

/*----------------------------------------------------------------------------*/

	if ( F_run == 1  )
	{
		Menu.Demo   = false;
		F_run = 2;
		mesh.mixer.stopAllAction();
		clip = mesh.geometry.animations[4];
		action = mesh.mixer.clipAction(clip);
		action.play();
	}
	else if ( F_walk == 1 )
	{
		Menu.Demo   = false;
		F_walk = 2;
		mesh.mixer.stopAllAction();
		clip = mesh.geometry.animations[2];
		action = mesh.mixer.clipAction(clip);
		action.play();
	}
	else if ( F_stop == 1  )
	{
		Menu.Demo   = true;
		F_stop = 2;
		mesh.mixer.stopAllAction();
		clip = mesh.geometry.animations[0];
		action = mesh.mixer.clipAction(clip);
		action.play();
	}

/*----------------------------------------------------------------------------*/
// ボタン入力
	if ( Go_BTN_Status && Back_BTN_Status )
	{
		;
	}
	
	if ( Menu.Plane )
	{
		if ( !Go_BTN_Status )
		{
			V.z += Menu.Speed * frameTime* -10;
		}
		if ( !Back_BTN_Status )
		{
			V.z += Menu.Speed * frameTime * 10;
		}
	}
	else
	{
		if ( !Go_BTN_Status )
		{
			V.z += Menu.Speed * frameTime;
		}
		if ( !Back_BTN_Status )
		{
			V.z += Menu.Speed * frameTime * -1;
		}
	}
	
	if ( Reset == 1 )
	{
		F_run  = 0;
		F_walk = 0;
		F_stop = 1;
		V.y = 0;
		V.z = 0;
		rad_Yaw 	= 0.0;
		rad_Pitch 	= 0.0;
		rad_Roll 	= 0.0;
		Go_BTN_Status 	= true;
		Back_BTN_Status = true;
		YR_BTN_Status   = true;
		YL_BTN_Status   = true;
		PU_BTN_Status   = true;
		PD_BTN_Status   = true;
		RR_BTN_Status   = true;
		RL_BTN_Status   = true;
		document.f1.Go_Button.style.background = '#77FF77';
		document.f1.Go_Button.style.opacity = 0.4;
		document.f1.Back_Button.style.background = '#77FF77';
		document.f1.Back_Button.style.opacity = 0.4;
		document.f1.YR_Button.style.background = '#77FF77';
		document.f1.YR_Button.style.opacity = 0.4;
		document.f1.YL_Button.style.background = '#77FF77';
		document.f1.YL_Button.style.opacity = 0.4;
		document.f1.PU_Button.style.background = '#77FF77';
		document.f1.PU_Button.style.opacity = 0.4;
		document.f1.PD_Button.style.background = '#77FF77';
		document.f1.PD_Button.style.opacity = 0.4;
		document.f1.RR_Button.style.background = '#77FF77';
		document.f1.RR_Button.style.opacity = 0.4;
		document.f1.RL_Button.style.background = '#77FF77';
		document.f1.RL_Button.style.opacity = 0.4;
	}
	if ( Reset == 2 )
	{
		Reset = 0;

/*----------------------------------------------------------------------------*/
// 簡易モデル用　リセット設定
		if( Menu.Plane )
		{
			P.x = 0;
			P.y = 15;
			P.z = -150;
		}
		else
		{
			P.x = 0;
			P.y = 0;
			P.z = 0;
		}
		
		mesh.rotation.set  (   0, 0, 0 );
		mesh.position.set  (   0, 0, 0 );
		Plane.rotation.set (   0, 0, 0  );
		Plane.position.set (   0, 15, -150 );
		Plane2.rotation.set (  0, 0, 0  );
		Plane2.position.set (  0, 15, -150 );
		Pilot.rotation.set (   0, 0, 0  );
		Pilot.position.set (   0, 15, -150 );
		axis_v.rotation.set(   0, 0, 0 );
		axis_v.position.set(   0, 0, 0 );
/*----------------------------------------------------------------------------*/
		Qbuff  = mesh.quaternion;
		Qbuff2 = Plane.quaternion;
		Qbuff3 = Pilot.quaternion;
		STP_BTN_Status 	= true;
		Go_BTN_Status 	= true;
		Back_BTN_Status = true;
		YR_BTN_Status 	= true;
		YL_BTN_Status 	= true;
		PU_BTN_Status 	= true;
		PD_BTN_Status 	= true;
		RR_BTN_Status 	= true;
		RL_BTN_Status 	= true;
		rad_Yaw 	= 0.0;
		rad_Pitch 	= 0.0;
		rad_Roll 	= 0.0;
		V.x             = 0.0;
		V.y             = 0.0;
		V.z             = 0.0;
		A_b.x		= 0.0;
		A_b.y		= 0.0;
		A_b.z		= 0.0;
	}
/*----------------------------------------------------------------------------*/

	if( ( V.z > 0.6 ) && ( F_run == 0) )
	{
		F_run  = 1;
		F_walk = 0;
	}
	else if( ( V.z > 0.0 ) && ( V.z < 0.6 ) && ( F_walk == 0 ) )
	{
		F_walk = 1;
		F_run  = 0;
		F_stop = 0;
	}

/*----------------------------------------------------------------------------*/
// モデル姿勢のクオータニオン設定
	if( Menu.Plane )
	{
		Qmodel.x = Qbuff2.x;
		Qmodel.y = Qbuff2.y;
		Qmodel.z = Qbuff2.z;
		Qmodel.w = Qbuff2.w;
	}
	else
	{
		Qmodel.x = Qbuff.x;
		Qmodel.y = Qbuff.y;
		Qmodel.z = Qbuff.z;
		Qmodel.w = Qbuff.w;
	}
	Qaxis    = axis_v.quaternion;
/*----------------------------------------------------------------------------*/
// ボタン操作による飛行制御
	if ( rad_Pitch > 0.0 )
	{
		target.setFromAxisAngle( X_axis, ( Math.PI / 180 ) * 1 );
		Qmodel.multiply(target);
		Av_b.x = ( Math.PI / 180 ) * 1;
	}
	else if ( rad_Pitch < 0.0 )
	{
		target.setFromAxisAngle( X_axis, ( Math.PI / 180 ) * -1 );
		Qmodel.multiply(target);
		Av_b.x = ( Math.PI / 180 ) * -1;
	}
	else if ( rad_Pitch == 0.0 )
	{
		target.setFromAxisAngle( X_axis, ( Math.PI / 180 ) * 0 );
		Qmodel.multiply(target);
		Av_b.x = ( Math.PI / 180 ) * 0;
	}
	
	if ( rad_Roll > 0.0 )
	{
		target.setFromAxisAngle( Z_axis, ( Math.PI / 180 ) * 1 );
		Qmodel.multiply(target);
		Av_b.z = ( Math.PI / 180 ) * 1;
	}
	else if ( rad_Roll < 0.0 )
	{
		target.setFromAxisAngle( Z_axis, ( Math.PI / 180 ) * -1 );
		Qmodel.multiply(target);
		Av_b.z = ( Math.PI / 180 ) * -1;
	}
	else if ( rad_Roll == 0.0 )
	{
		target.setFromAxisAngle( Z_axis, ( Math.PI / 180 ) * 0 );
		Qmodel.multiply(target);
		Av_b.z = ( Math.PI / 180 ) * 0;
	}
	
	if ( rad_Yaw > 0.0 )
	{
		target.setFromAxisAngle( Y_axis, ( Math.PI / 180 ) * 1 );
		Qmodel.multiply(target);
		Av_b.y = ( Math.PI / 180 ) * 1;
	}
	else if ( rad_Yaw < 0.0 )
	{
		target.setFromAxisAngle( Y_axis, ( Math.PI / 180 ) * -1 );
		Qmodel.multiply(target);
		Av_b.y = ( Math.PI / 180 ) * -1;
	}
	else if ( rad_Yaw == 0.0 )
	{
		target.setFromAxisAngle( Y_axis, ( Math.PI / 180 ) * 0 );
		Qmodel.multiply(target);
		Av_b.y = ( Math.PI / 180 ) * 0;
	}
	
/*----------------------------------------------------------------------------*/
// 航法計算
	Navigation();
	axis_v.position.x = P.x;
	axis_v.position.y = P.y;
	axis_v.position.z = P.z;

	if( Menu.Plane )
	{
		Plane.position.x = P.x;
		Plane.position.y = P.y;
		Plane.position.z = P.z;
		Plane.castShadow = true;
		Plane2.position.x = P.x;
		Plane2.position.y = P.y;
		Plane2.position.z = P.z;
		Plane2.castShadow = true;
		Pilot.position.x = P.x;
		Pilot.position.y = P.y;
		Pilot.position.z = P.z;
		Pilot.castShadow = true;
	}
	else
	{
		mesh.position.x = P.x;
		mesh.position.y = P.y;
		mesh.position.z = P.z;
		mesh.castShadow = true;
	}
/*----------------------------------------------------------------------------*/
	if( Menu.Plane )
	{
		RV6A_propMesh.rotation.z  += (propDelta * V.z);
		YS11R_propMesh.rotation.z  += (propDelta * V.z * -1);
		YS11L_propMesh.rotation.z  += (propDelta * V.z);
		HIEN_propMesh.rotation.z  += (propDelta * V.z);
		HIEN_propMesh2.rotation.z  += (propDelta * V.z);
		
		if( Plane_No == 2 )
		{  // YS-11
			if ( V.z == 0.0)
			{
				YS11_Gear.position.x = P.x;
				YS11_Gear.position.y = P.y;
				YS11_Gear.position.z = P.z;
			}
			else if( P.y < 6.0)
			{
				YS11_Gear.position.x = P.x;
				YS11_Gear.position.y = P.y;
				YS11_Gear.position.z = P.z;
			}
			else
			{
				scene.remove( YS11_Gear );
			}
		}
		if( (( Plane_No == 1 )||( Plane_No == 3 )||( Plane_No == 5 )) && ( P.y < 40) )
		{// MRJ90,F2A,HIEN
			scene.remove( Plane );
			scene.add( Plane2 );
		}
		else if(  Plane_No == 4 )
		{// Rider
			scene.remove( Plane2 );
			scene.add( Plane );
			P.y = 15;
		}
		else 
		{// MRJ90,F2A,HIEN
			scene.remove( Plane2 );
			scene.add( Plane );
		}
	}

	Qaxis.x = Qmodel.x;
	Qaxis.y = Qmodel.y;
	Qaxis.z = Qmodel.z;
	Qaxis.w = Qmodel.w;

	if( Menu.Plane )
	{
		Plane2.quaternion.x = Qmodel.x;
		Plane2.quaternion.y = Qmodel.y;
		Plane2.quaternion.z = Qmodel.z;
		Plane2.quaternion.w = Qmodel.w;
		Plane.quaternion.x = Qmodel.x;
		Plane.quaternion.y = Qmodel.y;
		Plane.quaternion.z = Qmodel.z;
		Plane.quaternion.w = Qmodel.w;
		Qbuff3.x = Qmodel.x;
		Qbuff3.y = Qmodel.y;
		Qbuff3.z = Qmodel.z;
		Qbuff3.w = Qmodel.w;
		Q_Gear.x = Qmodel.x;
		Q_Gear.y = Qmodel.y;
		Q_Gear.z = Qmodel.z;
		Q_Gear.w = Qmodel.w;
	}
	else
	{
		Qbuff.x = Qmodel.x;
		Qbuff.y = Qmodel.y;
		Qbuff.z = Qmodel.z;
		Qbuff.w = Qmodel.w;
	}

/*----------------------------------------------------------------------------*/
// Camera mode.
	if ( View_BTN_No == 0 )
	{//Look At

		camera0.position.z = 35 + Menu.Zoom;
		var relativeCameraOffset = new THREE.Vector3(0,0,0);
		relativeCameraOffset.x = P.x;
		relativeCameraOffset.y = P.y + 12;
		relativeCameraOffset.z = P.z;
		camera0.lookAt( relativeCameraOffset );

		activeCamera = camera0;
	}
	else if ( View_BTN_No == 1 )
	{//CloseUP
		camera1.position.z = 10 + Menu.Zoom;
		var relativeCameraOffset = new THREE.Vector3(0,0,0);
		relativeCameraOffset.x = P.x;
		relativeCameraOffset.y = P.y + 17.5;
		relativeCameraOffset.z = P.z;
		camera1.lookAt( relativeCameraOffset );
		activeCamera = camera1;
	}
	else if ( View_BTN_No == 2 )
	{//Chase
		camera2.position.x = P.x;
		camera2.position.y = P.y + 11;
		camera2.position.z = P.z + 150 + Menu.Zoom;
		activeCamera = camera2;
	}
	else if ( View_BTN_No == 3 )
	{// Far
		activeCamera = camera3;
	}
	else if ( View_BTN_No == 4 )
	{// Walk
		if(!Menu.Plane)
		{
			camera4.rotation.set( 0, 3.14, 0);
			camera4.position.x = 0.0;
			camera4.position.y = 20;
			camera4.position.z = -5 + Menu.Zoom;
			activeCamera = camera4;
		}
		else
		{
			if ( Plane_No == 0 )
			{ // RV-6A
				camera4.position.set(  -2,   12, -8 + Menu.Zoom );
			}
			else if ( Plane_No == 1 )
			{ // MRJ90
				camera4.position.set( -5, 11, -20 + Menu.Zoom );
			}
			else if ( Plane_No == 2 )
			{ // YS11
				camera4.position.set( 0,  12, -15 + Menu.Zoom );
			}
			else if ( Plane_No == 3 )
			{ // F2A
				camera4.position.set( 0,  11, -6 + Menu.Zoom );
			}
			else if ( Plane_No == 4 )
			{ // Rider
				camera4.position.set( 0,  15, 5 + Menu.Zoom );
			}
			else if ( Plane_No == 5 )
			{ // HIEN
				camera4.position.set( 0,  11, -8.5 + Menu.Zoom );
			}
			else if ( Plane_No == 6 )
			{ // 2000GT
				camera4.position.set( 0,  12, -7 + Menu.Zoom );
			}
			else if ( Plane_No == 7 )
			{ // 240Z
				camera4.position.set( 0,  12, -7 + Menu.Zoom );
			}
			else if ( Plane_No == 8 )
			{ // Tachikoma
				camera4.position.set( 0,  12, -6 + Menu.Zoom );
			}
			else if ( Plane_No == 9 )
			{ // GTR
				camera4.position.set( 0,  12, -7 + Menu.Zoom );
			}
			else if ( Plane_No == 10 )
			{ // Match5
				camera4.position.set( 0,  12, -7 + Menu.Zoom );
			}
			activeCamera = camera4;
		}
	}
/*----------------------------------------------------------------------------*/
// テキスト数値表示
	valueNode.nodeValue  	=  'Time:' + Time.toFixed(2);
	valueNode1.nodeValue 	=  'Px:' + P.x.toFixed(2) + ' Py:' + P.y.toFixed(2) + ' Pz:' + (P.z).toFixed(2);
	valueNode2.nodeValue 	=  'Pitch:' + ((  A_b.x ) * 180.0 / Math.PI ).toFixed(2)
				 + ' Yaw:'  + (( -A_b.y ) * 180.0 / Math.PI ).toFixed(2)
				 + ' Roll:' + (( -A_b.z ) * 180.0 / Math.PI ).toFixed(2);
	valueNode3.nodeValue 	=  'Vz:' + (-V.z).toFixed(2);
// alert("Time.toFixed(2)");
/*----------------------------------------------------------------------------*/
// 周期処理

	camera0.updateMatrixWorld();
	raycaster.setFromCamera( mouse, camera0 );
	camera1.updateMatrixWorld();
	raycaster.setFromCamera( mouse, camera1 );
	intersects = raycaster.intersectObjects( scene.children, true );
	
	if ( intersects.length > 3 ) {
		console.log("You touched", intersects.length);
	} else {
		console.log("Not touched", intersects.length);
	}
	
	var time = Date.now() * 0.0005;
	// eyes
	mesh.morphTargetInfluences[12] = (1 + Math.sin(4 * time)) / 2;
	mesh.morphTargetInfluences[10] = (1 + Math.sin(4 * time)) / 2;

/*
	if(( Menu.Plane )&&(ready))
	{
		Plane.morphTargetInfluences[0] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[1] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[2] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[3] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[4] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[5] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[6] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[7] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[8] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[9] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[10] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[11] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[12] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[13] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[14] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[15] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[16] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[17] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[18] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[19] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[20] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[21] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[22] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[23] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[24] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[25] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[26] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[27] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[28] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[29] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[30] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[31] = (1 + Math.sin(4 * time)) / 2;
		Plane.morphTargetInfluences[32] = (1 + Math.sin(4 * time)) / 2;
	}
*/
	if ( ready ) {
		helper.animate( frameTime );
		helper.render( scene, activeCamera );
	}
	renderer.render( scene, activeCamera );
}
/*----------------------------------------------------------------------------*/
// ウィンドウサイズ変更対応
/*----------------------------------------------------------------------------*/

			$("#labelKaiwa").focus();
			$("#henji").css("opacity","0");

function onWindowResize() {
	SCREEN_WIDTH = window.innerWidth;
	SCREEN_HEIGHT = window.innerHeight;
	renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
	camera0.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
	camera0.updateProjectionMatrix();
	camera1.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
	camera1.updateProjectionMatrix();
	camera2.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
	camera2.updateProjectionMatrix();
	camera3.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
	camera3.updateProjectionMatrix();
}
/*----------------------------------------------------------------------------*/
// ボタン処理
/*----------------------------------------------------------------------------*/
function WhoButtonHandler() {
	Who_BTN_No++;
	Who_BTN_No %= nameFiles.length;
	//  alert('No.' +  Who_BTN_No + 'です。');
	scene.remove( mesh );
	ObjectLoad( Who_BTN_No );	
}

function View_ButtonHandler() {
	View_BTN_No++;
	View_BTN_No %= ViewMode.length;
	document.f1.View_Button.value = ViewMode[ View_BTN_No ];
}

function STP_ButtonHandler() {
	STP_BTN_Status = !STP_BTN_Status;
	if ( F_song == 1 )
	{
		F_song = 0;
		playsound.stop(0);
	}
	mesh.mixer.stopAllAction();
	Reset++;
	if (STP_BTN_Status){
		document.f1.STP_Button.value='STP';
	} else {
		document.f1.STP_Button.value='RST';
	}
	
	if( (( Plane_No == 1 )||( Plane_No == 3 )||( Plane_No == 5 )) && ( Reset == 2 ) )
	{// MRJ90,F2A,HIEN
		scene.remove( Plane );
		scene.add( Plane2 );
	}
}

function Go_ButtonHandler() {
	Go_BTN_Status = !Go_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';
	
	if( Go_BTN_Status )
	{
		document.f1.Go_Button.style.background = '#77FF77';
		document.f1.Go_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.Go_Button.style.background = '#FFFF00';
		document.f1.Go_Button.style.opacity = 0.8;
	}
}

function Back_ButtonHandler() {
	Back_BTN_Status = !Back_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if( Back_BTN_Status )
	{
		document.f1.Back_Button.style.background = '#77FF77';
		document.f1.Back_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.Back_Button.style.background = '#FFFF00';
		document.f1.Back_Button.style.opacity = 0.8;
	}
}

function YR_ButtonHandler() {
	YR_BTN_Status = !YR_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';
	
	if ( Menu.Plane && ( P.y > 20 ) ) {
		if ( YR_BTN_Status ) {
			rad_Pitch  = 0.0 ;
			rad_Yaw   = 0.0 ;
		} else {
			rad_Pitch  = 1.0 ;
			rad_Yaw   = -1.0 ;
		}
	} else {
		if ( YR_BTN_Status ) {
			rad_Yaw = 0.0 ;
		} else {
			rad_Yaw = -1.0 ;
		}
	}
	
	if( YR_BTN_Status )
	{
		document.f1.YR_Button.style.background = '#77FF77';
		document.f1.YR_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.YR_Button.style.background = '#FFFF00';
		document.f1.YR_Button.style.opacity = 0.8;
	}
}

function YL_ButtonHandler() {
	YL_BTN_Status = !YL_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';
	
	if ( Menu.Plane && ( P.y > 20 ) ) {
		if ( YL_BTN_Status ) {
			rad_Pitch  = 0.0 ;
			rad_Yaw   = 0.0 ;
		} else {
			rad_Pitch  = 1.0 ;
			rad_Yaw   = 1.0 ;
		}
	} else {
		if ( YL_BTN_Status ) {
			rad_Yaw = 0.0 ;
		} else {
			rad_Yaw = 1.0 ;
		}
	}
	
	if( YL_BTN_Status )
	{
		document.f1.YL_Button.style.background = '#77FF77';
		document.f1.YL_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.YL_Button.style.background = '#FFFF00';
		document.f1.YL_Button.style.opacity = 0.8;
	}
}

function PU_ButtonHandler() {
	PU_BTN_Status = !PU_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if( !Menu.Plane )
	{
		if ( Menu.Word == true )
		{
			random_x = Math.round( Math.random()*50 )*1.1;
setTimeout(function() {	$(".align_bottom").before("<div class='align_left' style='padding-left:" + random_x + "px;'><span class='brain_say'>" + "私のゴーストがささやくのよ" + "</span></div>");}, 0);
			var position = $("#henji div:last-child").offset().top - 0;
			$("#scrollarea").animate({scrollTop: position},"slow");
		}
//		if ( Menu.Voice == true ){ playVoice("ja", "私のゴーストがささやくのよ");}
//		playVoice("ja","まかはんにゃはらみたしんぎょうかんじざいぼさつぎょうじんはんにゃはらみったじしょうけんごうんかいくうどいっさいくやくしゃりししきふいくうくうふいしきしきそくぜくうくうそくぜしきじゅそうぎょうしきやくぶにょぜしゃりしぜしょほうくうそうふしょうふめつふくふじょうふぞうふげんぜこくうちゅうむしきむじゅそうぎょうしきむげんにびぜっしんいむしきしょうこうみそくほうむげんかいないしむいしきかいむむみょうやくむむみょうじんないしむろうしやくむろうしじんむくしゅうめつどうむちやくむとくいむしょとくこぼだいさったえはんにゃはらみったこしんむけいげむけいげこむうくふおんりいっさいてんどうむそうくきょうねはんさんぜしょぶつえはんにゃはらみったことくあのくたらさんみゃくさんぼだいこちはんにゃはらみったぜだいじんしゅぜだいみょうしゅぜむじょうしゅぜむとうどうしゅのうじょいっさいくしんじつふここせつはんにゃはらみったしゅそくせつしゅわつぎゃていぎゃていはらぎゃていはらそうぎゃていぼじそわかはんにゃしんぎょう");
	}
	
	if( PU_BTN_Status )
	{
		rad_Pitch = 0.0 ;
		document.f1.PU_Button.style.background = '#77FF77';
		document.f1.PU_Button.style.opacity = 0.4;
	//	playVoice("ja", "私のゴーストがささやくのよ");
	}
	else
	{
		rad_Pitch = 1.0 ;
		document.f1.PU_Button.style.background = '#FFFF00';
		document.f1.PU_Button.style.opacity = 0.8;
	//	playVoice("ja", "私の名前はくさなぎもとこ");
	}
}

function PD_ButtonHandler() {
	PD_BTN_Status = !PD_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if( !Menu.Plane )
	{
		ready = true;
		action.play();

		if( Song_BTN_No == 1 )
		{
			setTimeout(function() {	Sound( 0 );}, 5000);
		}
		else
		{
			setTimeout(function() {	Sound( 0 );}, 0);
		}
		
		if ( Menu.Word == true )
		{
			random_x = Math.round( Math.random()*50 )*1.1;
setTimeout(function() {	$(".align_bottom").before("<div class='align_left' style='padding-left:" + random_x + "px;'><span class='brain_say'>" + messages[Sound_num] + "</span></div>");}, 0);
			var position = $("#henji div:last-child").offset().top - 0;
			$("#scrollarea").animate({scrollTop: position},"slow");
		}
		if ( Menu.Voice == true ){ playVoice("ja", messages[Sound_num+1]);}
		Sound_num++;if( Sound_num == 28 ){ Sound_num = 0;}
		action.reset();
	}
	
	if( PD_BTN_Status )
	{
		rad_Pitch = 0.0 ;
		document.f1.PD_Button.style.background = '#77FF77';
		document.f1.PD_Button.style.opacity = 0.4;
	}
	else
	{
		rad_Pitch = -1.0 ;
		document.f1.PD_Button.style.background = '#FFFF00';
		document.f1.PD_Button.style.opacity = 0.8;
	}
}

function RR_ButtonHandler() {
	RR_BTN_Status = !RR_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if( !Menu.Plane )
	{
		if( RR_BTN_Status )
		{
			document.f1.RR_Button.style.background = '#77FF77';
			document.f1.RR_Button.style.opacity = 0.4;
		// ハイキック
			mesh.mixer.stopAllAction();
			clip = mesh.geometry.animations[31];
			action = mesh.mixer.clipAction(clip);
			action.play();
			playVoice("ja", "せい");
		}
		else
		{
			document.f1.RR_Button.style.background = '#FFFF00';
			document.f1.RR_Button.style.opacity = 0.8;
		// ハイキック
			mesh.mixer.stopAllAction();
			clip = mesh.geometry.animations[31];
			action = mesh.mixer.clipAction(clip);
			action.play();
			playVoice("ja", "うぉりゃ");
		}
	}
	else
	{
		if ( RR_BTN_Status ) {
			rad_Roll = 0.0 ;
		} else {
			rad_Roll = -1.0 ;
		}
	}
}

function RL_ButtonHandler() {
	RL_BTN_Status = !RL_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if( !Menu.Plane )
	{
		if( RL_BTN_Status )
		{
			document.f1.RL_Button.style.background = '#77FF77';
			document.f1.RL_Button.style.opacity = 0.4;
		// 左フック
			mesh.mixer.stopAllAction();
			clip = mesh.geometry.animations[10];
			action = mesh.mixer.clipAction(clip);
			action.play();
			playVoice("ja", "はっ");
		}
		else
		{
			document.f1.RL_Button.style.background = '#FFFF00';
			document.f1.RL_Button.style.opacity = 0.8;
		// 左ストレート
			mesh.mixer.stopAllAction();
			clip = mesh.geometry.animations[16];
			action = mesh.mixer.clipAction(clip);
			action.play();
			playVoice("ja", "とぉ");
		}
	}
	else
	{
		if ( RL_BTN_Status ) {
			rad_Roll = 0.0 ;
		} else {
			rad_Roll = 1.0 ;
		}
	}
}
/*----------------------------------------------------------------------------*/
//体に触れた場合の判定フラグ用
/*----------------------------------------------------------------------------*/
//体に触れた場合のランダム発言とモーション

function onDocumentMouseMove( event ) {

	event.preventDefault();
	mouse.x =   ( event.clientX / window.innerWidth  ) * 2 - 1;
	mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

// console.log( mouse.x, mouse.y );
// console.log("MouseMoved");

/*
	if (intersects.length > 5) {
// console.log("You touched");
		mesh.mixer.stopAllAction();
		clip = mesh.geometry.animations[play_num];
		action = mesh.mixer.clipAction(clip);
		action.play();
		play_num++;
		if( play_num > vmdFiles2.length ) { play_num = 0; }
		if ( Menu.Word == true )
		{
			random_x = Math.round( Math.random()*50 )*1.1;
setTimeout(function() {	$(".align_bottom").before("<div class='align_left' style='padding-left:" + random_x + "px;'><span class='brain_say'>" + "なにすんだよ" + "</span></div>");}, 0);
			var position = $("#henji div:last-child").offset().top - 0;
			$("#scrollarea").animate({scrollTop: position},"slow");
		}
		if ( Menu.Voice == true ){ playVoice("ja", "なにすんだよ");}
	} else {
// console.log("not touched");
	}
*/
}

function onDocumentMouseDown( event ) {
	event.preventDefault();
	var intersects = raycaster.intersectObjects( objects );
	if ( intersects.length > 0 ) {
		controls0.enabled = false;
	}
// console.log("MouseDowned");
}

function onDocumentMouseUp( event ) {
	event.preventDefault();
	controls0.enabled = true;

	if (intersects.length > 3) {
// console.log("You touched");
		mesh.mixer.stopAllAction();
		clip = mesh.geometry.animations[play_num];
		action = mesh.mixer.clipAction(clip);
		action.play();
		play_num++;
		if( play_num > vmdFiles2.length ) { play_num = 0; }
		if ( Menu.Word == true )
		{
			random_x = Math.round( Math.random()*50 )*1.1;
setTimeout(function() {	$(".align_bottom").before("<div class='align_left' style='padding-left:" + random_x + "px;'><span class='brain_say'>" + "くすぐったいよ" + "</span></div>");}, 0);
			var position = $("#henji div:last-child").offset().top - 0;
			$("#scrollarea").animate({scrollTop: position},"slow");
		}
		if ( Menu.Voice == true ){ playVoice("ja", "くすぐったいよ");}
	} else {
// console.log("not touched");
	}
// console.log("MouseUped");
}

/*----------------------------------------------------------------------------*/
// PC Key 入力
/*----------------------------------------------------------------------------*/
function onKeyDown ( event ) {
	switch( event.keyCode ) {
		case 38: /*up*/	  Go_KeyOnHandler(); break;
		case 87: /*W*/ 	  Go_KeyOnHandler(); break;
		case 40: /*down*/ Back_KeyOnHandler(); break;
		case 83: /*S*/ 	  Back_KeyOnHandler(); break;
		case 37: /*left*/ YL_KeyOnHandler(); break;
		//case 65: /*A*/    YL_KeyOnHandler(); break;
		case 39: /*right*/YR_KeyOnHandler(); break;
		case 68: /*D*/    YR_KeyOnHandler(); break;
		case 81: /*Q*/	  armMovement =  1 ; break;
		//case 65: /*A*/	  armMovement = -1 ; break;
		case 65: /*A*/	  armMovement =  0 ; break;
	}
}

function Go_KeyOnHandler() {
	Go_BTN_Status = !Go_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';
	
	if( Go_BTN_Status )
	{
		document.f1.Go_Button.style.background = '#77FF77';
		document.f1.Go_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.Go_Button.style.background = '#FFFF00';
		document.f1.Go_Button.style.opacity = 0.8;
	}
}
function Back_KeyOnHandler() {
	Back_BTN_Status = !Back_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if( Back_BTN_Status )
	{
		document.f1.Back_Button.style.background = '#77FF77';
		document.f1.Back_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.Back_Button.style.background = '#FFFF00';
		document.f1.Back_Button.style.opacity = 0.8;
	}
}
function YR_KeyOnHandler() {
	YR_BTN_Status = !YR_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if ( YR_BTN_Status ) {
		rad_Yaw = 0.0 ;
	} else {
		rad_Yaw = -1.0 ;
	}
	
	if( YR_BTN_Status )
	{
		document.f1.YR_Button.style.background = '#77FF77';
		document.f1.YR_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.YR_Button.style.background = '#FFFF00';
		document.f1.YR_Button.style.opacity = 0.8;
	}
}

function YL_KeyOnHandler() {
	YL_BTN_Status = !YL_BTN_Status;
	STP_BTN_Status = true;
	Reset = 0;
	document.f1.STP_Button.value='STP';

	if ( YL_BTN_Status ) {
		rad_Yaw = 0.0 ;
	} else {
		rad_Yaw = 1.0 ;
	}
	if( YL_BTN_Status )
	{
		document.f1.YL_Button.style.background = '#77FF77';
		document.f1.YL_Button.style.opacity = 0.4;
	}
	else
	{
		document.f1.YL_Button.style.background = '#FFFF00';
		document.f1.YL_Button.style.opacity = 0.8;
	}
}
/*-----------------------------------------------------------------------------
クォータニオンを用いた航法計算
-------------------------------------------------------------------------------
機能内容

（１）　クォータニオンを用いた航法計算

------------------------------------------------------------------------------*/
function  Navigation(){
	var Q_tmp  = new THREE.Quaternion();
	var Pv_L   = new THREE.Vector3( 0,  0,  0 );  // 機体速度
	var Av_L   = new THREE.Vector3( 0,  0,  0 );  // 機体角速度
	var upd    =  [ 0, 0, 0,
			0, 0, 0,
			0, 0, 0 ];
	
	Q_tmp  = Oil2qtn( Av_b   );
	Qmodel = Qmult  ( Qmodel, Q_tmp );
	DCM_bL = Q2dcm  ( Qmodel );
	upd    = updmx  ( A_b    );
       	Pv_L   = Mtxvec ( DCM_bL, V );
       	Av_L   = Mtxvec ( upd, Av_b );
     	P      = Vadd   ( P,   Pv_L );
       	A_b    = Vadd   ( A_b, Av_L );
}

/*-----------------------------------------------------------------------------
クォータニオン化ベクトル変換
-------------------------------------------------------------------------------
機能内容

（１）　ベクトル（Ｘ，Ｙ，Ｚ）からクォータニオン（Ｑ０、Ｑ１、Ｑ２、Ｑ３）を
　　　　設定する。

------------------------------------------------------------------------------*/
function  Vec2qtn( V ){
	var	Q= new THREE.Quaternion();
	var	a,b,c;		/* 計算バッファ */
	
	a = V.x * V.x + V.y * V.y + V.z * V.z;
	
	if( a != 0.0 ){
        	a = Math.sqrt( a       );
        	b = Math.cos ( a * 0.5 );
        	c = Math.sin ( a * 0.5 );
        	
        	Q.w = b;
        	Q.x = V.x / a * c;
        	Q.y = V.y / a * c;
        	Q.z = V.z / a * c;
    	}else{
        	Q.w = 1.0; Q.x = Q.y = Q.z = 0.0;
    	}
    	return Q;
}

/*-----------------------------------------------------------------------------
クォータニオン化オイラー変換
-------------------------------------------------------------------------------
機能内容

（１）　オイラー角（Ｘ，Ｙ，Ｚ）からクォータニオン（Ｑ０、Ｑ１、Ｑ２、Ｑ３）を
　　　　設定する。

------------------------------------------------------------------------------*/
function  Oil2qtn( V ){
	var    Q    = new THREE.Quaternion();
	var    qbuf = new THREE.Quaternion();
	var    Vbuf = new THREE.Vector3( 0,  0,  0 );
	
	Vbuf.x = 0.0;
	Vbuf.y = 0.0;
	Vbuf.z = V.z;
	Q = Vec2qtn( Vbuf );
	
	Vbuf.x = 0.0;
	Vbuf.y = V.y;
	Vbuf.z = 0.0;
	qbuf = Vec2qtn( Vbuf );
	Q = Qmult( Q, qbuf );
	
	Vbuf.x = V.x;
	Vbuf.y = 0.0;
	Vbuf.z = 0.0;
	qbuf = Vec2qtn( Vbuf );
	Q = Qmult( Q, qbuf );
    	return Q;
}

/*-----------------------------------------------------------------------------
姿勢更新行列生成
-------------------------------------------------------------------------------
機能内容

（１）　角度ベクトル A_b から 更新行列 upd[]を作成する。

------------------------------------------------------------------------------*/
function  updmx( A_b ){

	var upd    =  [ 0, 0, 0,
			0, 0, 0,
			0, 0, 0 ];
	var sin_p,sin_q,sin_r;
	var cos_p,cos_q,cos_r;
	sin_p = Math.sin( A_b.x );
	sin_q = Math.sin( A_b.y );
	sin_r = Math.sin( A_b.z );
	cos_p = Math.cos( A_b.x );
	cos_q = Math.cos( A_b.y );
	cos_r = Math.cos( A_b.z );
	upd[0] = 1.0;
	upd[1] = sin_p * sin_q / cos_q;
	upd[2] = cos_p * sin_q / cos_q;
	upd[3] = 0.0;
	upd[4] = cos_p;
	upd[5] = (-sin_q * sin_r - sin_p);
	upd[6] = 0.0;
	upd[7] = sin_p / cos_q;
	upd[8] = cos_p / cos_q;
	return upd;
}

/*-----------------------------------------------------------------------------
クォータニオンの更新
-------------------------------------------------------------------------------
機能内容

（１）　角度増分ベクトル（Ｘ，Ｙ，Ｚ）から
　　　　クォータニオン（Ｑ０、Ｑ１、Ｑ２、Ｑ３）を更新する。

------------------------------------------------------------------------------*/
function  Qvupdt( Q, V ){
	var    a,b,w, x, y, z;
	a = V.x * V.x + V.y * V.y + V.z * V.z;
	b = 1.0 - a / 12.0;
	
	w = Q.w * b + (-V.x * Q.x - V.y * Q.y - V.z * Q.z ) / 2.0;
	x = Q.x * b + ( V.x * Q.w - V.y * Q.z + V.z * Q.y ) / 2.0;
	y = Q.y * b + ( V.x * Q.z + V.y * Q.w - V.z * Q.x ) / 2.0;
	z = Q.z * b + (-V.x * Q.y + V.y * Q.x + V.z * Q.w ) / 2.0;
	
	Q.w = w; Q.x = x; Q.y = y; Q.z = z;
	return Q;
}

/*-----------------------------------------------------------------------------
クォータニオンの正規化
-------------------------------------------------------------------------------
機能内容

（１）　クォータニオン（Ｑ０、Ｑ１、Ｑ２、Ｑ３）を正規化する。

------------------------------------------------------------------------------*/
function  Qnorm( Q ){
	var    s;
	s = ( 3.0 - Q.w * Q.w - Q.x * Q.x - Q.y * Q.y - Q.z * Q.z ) * 0.5;
	Q.w *= s;  Q.x *= s;  Q.y *= s;  Q.z *= s;
	return Q;
}

/*-----------------------------------------------------------------------------
クォータニオンの共役化
-------------------------------------------------------------------------------
機能内容

（１）　クォータニオン（Ｑ０、Ｑ１、Ｑ２、Ｑ３）を共役化する。

------------------------------------------------------------------------------*/
function  Qconj( Q ){
	Q.w =  Q.w;
	Q.x = -Q.x;
	Q.y = -Q.y;
	Q.z = -Q.z;
	return Q;
}

/*-----------------------------------------------------------------------------
クォータニオンの積
-------------------------------------------------------------------------------
機能内容

（１）　クォータニオンＱｃ＝Ｑａ＊Ｑｂを計算する。

------------------------------------------------------------------------------*/
function  Qmult( Qa, Qb ){
	var    Qc = new THREE.Quaternion();
	Qc.w = Qa.w * Qb.w - Qa.x * Qb.x - Qa.y * Qb.y - Qa.z * Qb.z;
	Qc.x = Qa.x * Qb.w + Qa.w * Qb.x - Qa.z * Qb.y + Qa.y * Qb.z;
	Qc.y = Qa.y * Qb.w + Qa.z * Qb.x + Qa.w * Qb.y - Qa.x * Qb.z;
	Qc.z = Qa.z * Qb.w - Qa.y * Qb.x + Qa.x * Qb.y + Qa.w * Qb.z;
	return Qc;
}

/*-----------------------------------------------------------------------------
クォータニオンの方向余弦行列化
-------------------------------------------------------------------------------
機能内容

（１）　クォータニオン（Ｑ０、Ｑ１、Ｑ２、Ｑ３）から方向余弦行列を作成する。

------------------------------------------------------------------------------*/
function  Q2dcm( Q ){
	var DCM = [ 0, 0, 0,
		    0, 0, 0,
		    0, 0, 0 ];
	var	q00,q11,q22,q33,
		q01,q02,q03,
		q12,q23,q31;
	
	q00 = Q.w * Q.w; q11 = Q.x * Q.x; q22 = Q.y * Q.y; q33 = Q.z * Q.z;
	q01 = Q.w * Q.x; q02 = Q.w * Q.y; q03 = Q.w * Q.z;
	q12 = Q.x * Q.y; q23 = Q.y * Q.z; q31 = Q.z * Q.x;
	
	DCM[0] = q00 + q11 - q22 - q33;
	DCM[1] = 2.0 * ( q12 - q03 );
	DCM[2] = 2.0 * ( q31 + q02 );
	
	DCM[3] = 2.0 * ( q12 + q03 );
	DCM[4] = q00 - q11 + q22 - q33;
	DCM[5] = 2.0 * ( q23 - q01 );
	
	DCM[6] = 2.0 * ( q31 - q02 );
	DCM[7] = 2.0 * ( q23 + q01 );
	DCM[8] = q00 - q11 - q22 + q33;
	return DCM;
}

/*-----------------------------------------------------------------------------
ベクトル和関数 [3]+[3]
-------------------------------------------------------------------------------
機能内容

（１）　ベクトルＡ＋ベクトルＢをベクトルＡに設定する。

------------------------------------------------------------------------------*/
function  Vadd( A, B ){
	A.x += B.x;
	A.y += B.y;
	A.z += B.z;
	return A;
}

/*-----------------------------------------------------------------------------
行列計算[3*3]*[3]
-------------------------------------------------------------------------------
機能内容

（１）　３×３行列＊３要素ベクトルを計算する。

------------------------------------------------------------------------------*/
function  Mtxvec( DCM, V ){
	var    O = new THREE.Vector3( 0,  0,  0 );
	O.x = DCM[0] * V.x + DCM[1] * V.y + DCM[2] * V.z;
	O.y = DCM[3] * V.x + DCM[4] * V.y + DCM[5] * V.z;
	O.z = DCM[6] * V.x + DCM[7] * V.y + DCM[8] * V.z;
	return O;
}

/*-----------------------------------------------------------------------------
角度データ・リミッタ（±２π）
-------------------------------------------------------------------------------
機能内容

（１）　角度ベクトルを±２πラジアンの範囲でリミットする。

------------------------------------------------------------------------------*/
function  Alimit( A ){
	if (A.x >=  (Math.PI * 2)) A.x -= (Math.PI * 2);
	if (A.x <= -(Math.PI * 2)) A.x += (Math.PI * 2);
	if (A.y >=  (Math.PI * 2)) A.y -= (Math.PI * 2);
	if (A.y <= -(Math.PI * 2)) A.y += (Math.PI * 2);
	if (A.z >=  (Math.PI * 2)) A.z -= (Math.PI * 2);
	if (A.z <= -(Math.PI * 2)) A.z += (Math.PI * 2);
	return A;
}

/*-----------------------------------------------------------------------------
外積
-------------------------------------------------------------------------------
機能内容

（１）　３ポイントの座標で構成される平面の外積ベクトルを求める。

------------------------------------------------------------------------------*/
function  Div( A, B, C ){
	var    O = new THREE.Vector3( 0,  0,  0 );
	
	O.x = ( B.y - A.y ) * ( C.z - B.z ) - ( B.z - A.z ) * ( C.y - B.y );
	O.y = ( B.z - A.z ) * ( C.x - B.x ) - ( B.x - A.x ) * ( C.z - B.z );
	O.z = ( B.x - A.x ) * ( C.y - B.y ) - ( B.y - A.y ) * ( C.x - B.x );
	return O;
}

/*-----------------------------------------------------------------------------
内積
-------------------------------------------------------------------------------
機能内容

（１）　２ポイントの座標の内積を求める。

------------------------------------------------------------------------------*/
function  Dot( A, B ){
	var    dot;
	dot = A.x * B.x + A.y * B.y + A.z * B.z;
	return dot;
}

/*-----------------------------------------------------------------------------
方向余弦からオイラー角化
-------------------------------------------------------------------------------
機能内容

（１）　方向余弦行列からオイラー角を計算する。

------------------------------------------------------------------------------*/
function  Dcm2vec( m ){
	var    O = new THREE.Vector3( 0,  0,  0 );
	O.x =  Math.atan( m[ 7 ] / m[ 8 ] );
	O.y = -Math.asin( m[ 6 ] );
	O.z =  Math.atan( m[ 3 ] / m[ 0 ]  );
	return O;
}

/*-----------------------------------------------------------------------------
#define PI                              3.14159265358979323846
#define PI2                             6.28318530717958647692
#define G                               9.8
#define FT                         	0.3048
#define IN_RANGE(x,minX,maxX)           (((x)>=(minX)) && ((x)<=(maxX)))
#define OUT_RANGE(x,minX,maxX)          (((x)< (minX)) || ((x)> (maxX)))
#define CUT_LIMIT(x,xMin,xMax)          (x>xMax)?xMax:((x<xMin)?xMin:x)
#define NEAR_ZERO(x)                    (((x)<1.0e-5)&&((x)>-1.0e-5))
#define MOD(a, b)                       (((a) + (b)) % (b))
#define NUM_ARRAY(array)                (sizeof(array)/sizeof(*array))
#define SD_MAX(x,y)                     (((x)>=(y))?(x):(y))
#define SD_MIN(x,y)                     (((x)<=(y))?(x):(y))
#define SD_MAX3(x1,x2,x3)               (((x1)>=(x2))?(((x1)>=(x3))?(x1):(x3)):(((x2)>=(x3))?(x2):(x3)))
#define SD_MIN3(x1,x2,x3)               (((x1)<=(x2))?(((x1)<=(x3))?(x1):(x3)):(((x2)<=(x3))?(x2):(x3)))
#define POW(x)                          ((x)*(x))
#define KEEP_360(deg)                   (((deg)>=0.0)?(fmod((deg),360.0)):(fmod((deg),360.0)+360.0))
#define KEEP_180(deg)                   (KEEP_360((deg)+180.0)-180.0)
#define KEEP_FPI(rad)                   (((rad)>=0.0)?(fmod((rad),PI2)):(fmod((rad),PI2)+PI2))
#define KEEP_PI(rad)                    (KEEP_FPI((rad)+Math.PI)-Math.PI)
#define KEEP_HPI(rad)                   fmod((rad),Math.PI/2.0)
#define DEG2RAD(deg)                    ((deg) * Math.PI / 180.0 )
#define RAD2DEG(rad)                    ((rad) * 180.0 / Math.PI )
#define DEG_SIN(deg)                    (Math.sin((double)DEG2RAD(deg))) 
#define DEG_COS(deg)                    (Math.cos((double)DEG2RAD(deg))) 
#define DEG_TAN(deg)                    (Math.tan((double)DEG2RAD(deg))) 
#define SD_DSWAP(x,y)                   {double tmp;tmp=(x);(x)=(y);(y)=tmp;}
#define SD_FSWAP(x,y)                   {double tmp;tmp=(x);(x)=(y);(y)=tmp;}
#define SD_ISWAP(x,y)                   {int tmp;tmp=(x);(x)=(y);(y)=tmp;}
-----------------------------------------------------------------------------*/
</script>
</body>
</html>
<!-- ---------------------------------------
Good Luck!
---------------------------------------- -->

