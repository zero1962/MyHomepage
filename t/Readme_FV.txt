------------------------------------------------------------------------


３次元モデル表示プログラム　Ver 0.0β


[ FLIGHT_VIEW( FV と称する ) C++ ]


2008.10.26 Kuniyuki.Tsujimoto
-------------------------------------------------------------------------------
1. 概要：
位置の変化量、姿勢の変化量をクォータニオンで座標変換しなが積算することで
３次元モデルをさまざまな角度から表示できるツールです。

-------------------------------------------------------------------------------
2. 実行方法：
本パッケージは、Windowsパソコン上の適当なフォルダにzip解凍してください。

展開されたフォルダ内には２つのフォルダ（ FLIGHT_VIEW、FLIGHT_VIEW_project ）が
あります。

FLIGHT_VIEWフォルダ内のFLIGHT_VIEW.exe をクリックすることで実行できます。

FLIGHT_VIEW_projectフォルダ内は、VC++の開発プロジェクトで、ソースファイルが
そろっています。改造したい方は自由にできます。

本プログラムは、Windowsアプリケーションの多くの要素を含んだサンプルプログラムとして
ご利用ください。

-------------------------------------------------------------------------------
3. 実飛行データ等の表示データの再生手順：

(1) 4.項に示すデータフォーマットに変換した実飛行データを所定のファイル名(POS_FLT1-001FV.csv)
    で保管しておく。

(2) 2.項の要領でFVを起動する。

(3) スペースキーを押すと表示データが再生される。

基本的な操作は以降に示す。

-------------------------------------------------------------------------------
4. 表示再生データのフォーマット定義

(1) データ並び：
時刻, 位置x(左右),　位置y(前後),  位置h(高度),　　Pitch(deg),　Roll(deg),  Yaw(deg)

(2) ファイル形式：
CSV形式のテキストファイル

(3) ファイル名：（例）POS_FLT1-001FV.csv 等

実飛行データを扱う場合、経度、高度、緯度をそのまま位置のに適用すると初期位置が
画面の中央にならないため、初期の緯度経度高度からの変位量に変換して適用してください。
表示スケールは実変位量の場合、可視範囲に表示できない場合があるので、適度に縮小して
適用してください。
-------------------------------------------------------------------------------
5. 機能
・モデル・データをＰＣ上で３次元表示する。
・位置、姿勢情報の時間履歴データに基づき、回転並進移動する。
・位置軌跡と、姿勢の軌跡をデルタ、翼端、矩形で表現する。
・複数のモデルを同時に表示する。
・軌跡表示に透明感を出す。
・マウス、キーボードで視点操作する。
・マウス、キーボードでマニュアル操作モードの機体を操作する。
・メモ帳(notepad.exe)による初期設定ファイル、及びヘルプ表示。(readme.txt)
・バージョン情報表示
・ダイアログから時間履歴データ(****.csv)を選択できる。
・ダイアログから３次元モデル・ファイル(****.dat,****.wrl)を選択できる。
・ダイアログから参照データファイルを指定してグラフ表示できる。
・１Ｈｚの高度データを補完できる。
・履歴実行を任意の時点でポーズできる。
・ポーズ時、ステップ前進、ステップバックができる。
・ヘルプ表示
・バージョン表示
・チェックボックスで位置高度軌跡表示を指示できる。
・チェックボックスで全体画面表示できる。
・ダイアログの多重起動は禁止する。
・サブウィンドウでファイル入力に同期してデータの数値表示、グラフ表示ができる。
・グラフは、オートスケールできる。
・サブウィンドウで全体表示ができる。 
・軌跡数に最大値を設ける。（データシフト）
・ダイアログ・コンボボックスから軌跡タイプを選択できる。
・飛行軌跡ダイアログ、サブウィンドウともに拡大表示できる。
・指定した時間より表示を開始する。
・リピート指定で繰り返し実行する。

座標系
・Open-GL グラフィック表示 x:右、  y:上、  z:手前
・ローカル座標             x:奥、  y:右、  z:下
・機体座標                 x:機首、y:右舷、z:下   姿勢：右ねじ

初期設定ファイル
・FLIGHT_VIEW.ini
・#はコメント
・キーワードでパラメータを指定

３次元モデル・ファイル
・VRMLは、*****.wrl　（法線情報がない。他のモデルに対応できない。）
・ＧＵＩ及び初期設定ファイルで指定する。

時間履歴データ・ファイル
・****.csv ＧＵＩ及び初期設定ファイルで指定する。
・# はコメント
・# Scale 0.1 で位置情報の倍率を指定する。指定の無い場合は、1.0とする。

キーボード定義
・Enter：終了
・ESC  ：終了
・矢印キー     ：視点回転移動
・PageUp/Down ：表示拡大縮小
・Shift：表示変更
・CTRL ：キー機能変更
・Space：ポーズ・解除
・BS   ：時間履歴データ処理開始
・Q    ：時間履歴データ・ファイル入力サンプリング間引き（高速）Pause時Stepforward
・A    ：時間履歴データ・ファイル入力サンプリング連続　（低速）Pause時Stepback
・F3:RGBカラー指定ダイアログ

  マニュアル操作モード時
・8:Pitch up
・2:Pitch down
・4:Roll CCW
・5:Roll  CW
・7:Yaw left
・9:Yaw right
・3:前進
・1:後退

マウス定義
・左ボタンのダブルクリック：時間履歴データ処理開始
・右ボタンのダブルクリック：ダイアログ・メニュー表示
・左ボタン押しながら移動  ：視点操作、    マニュアル操作モードでの機体姿勢操作
・右ボタン押しながら移動  ：画面拡大縮小、マニュアル操作モードでの機体速度操作
------------------------------------------------------------------------
製作記録
2008.10.26 sun
・一部のバグ修正
・マニュアル操作モードで飛行記録データを書き出せるようにした。
・ただし、飛行記録の再生と同時出力に問題あり。仕様制限とする。
・-180°で機体の表示が不連続になる。（少し傾いていると発生しない。）
・サブウィンドウの初期表示位置を確定させた。


2006.04.06 thu
・ヘルプ、初期設定表示が前面にでない。

2005.12.09 fri
・翼端軌跡の連続線化ができた。
・バージョン情報の表示をシステム・メニューに追加した。

2005.12.08 thu
・MSVCの無い環境では必要な.dllがない。リリースリンクする。

2005.12.07 wed
・モードレス・ダイアログの消去できるようになった。
・サブウィンドウの再起動ができない。
　サブウィンドウ再起動失敗の原因がわかった。
  wglMakeCurrent(sub_pDC->GetSafeHdc(), sub_hRC);
・チェックボックスのオフ対応できた。
・グラフ表示をファイル入力に同期させた。
・Return キーをOnOK関数で受ける処理
・OnKeyDown関数が効かなくなった。OnOK関数を削除すると復旧した。
・Open-GL日本語表示を確認、全体のカラーがおかしくなる。

2005.12.06 tue
・スライダー・コントロールで背景カラー調整できる。
・リピート機能追加。
・サブウィンドウのサイズ変更ができなくなった。解決。
・サブウィンドウの再起動ができなくなった。

2005.12.05 mon
・サブウィンドウでもマウスキーボード操作を有効にする。
・初期設定ファイルの編集後、再読み込みする。

2005.11.25 fri
・開始時間入力エディットボックス作成。矢印キー編集と画面が連動してしまう。解決
・エディットボックスの入力値取得は、ボタン指示で確定処理する。
・カレント・ディレクトリの取得移動追加によりヘルプ、初期設定ファイル表示が確実になった。
・連続線軌跡は、gl_Begin,gl_Endの間で座標変換できない。

2005.11.24 thu
・最近意欲が湧かず、このプログラムを見るとやたら疲れる。
・1Hz高度データ補完処理。
・コンボボックスから軌跡データを選択。
・画面の拡大表示切り替えにはフラグ制御必要。

2005.11.22 tue
・ダイアログを外部から閉じることができない。
・マウスで画面の拡大縮小を操作する。
・軌跡最大数処理
・初期設定ファイル見直し後に再初期化しようとしたができない。
・参照データファイル指定機能追加。

2005.11.21 mon
・サブウィンドウ表示、Open-GLの制御切換には工夫が必要。
・全体表示の適切なサイズ検討必要

2005.11.18 fri
・ファイル選択でフォルダ移動したあと、ヘルプ・ファイルが開けない。
　（カレント・パスが移動しているから。）

2005.11.17 thu
・初期設定ファイルにグラフ設定追加。
・グラフ表示機能、フィード位置、データ表示調整。

2005.11.16 wed
・readme.txtの見直し。
・Stepback,Stepforwardの実現。
・モデル・ファイル選択の実現。Cstringの変換で困る。
・チェックボックスで位置高度軌跡指示
・チェックボックスで全体画面表示指示。適切なスケール設定が課題。
・ダイアログ多重起動を禁止した。
・グラフ・ダイアログを作成中。最大，最小が適切でない。

2005.11.15 tue
・Open-GL 透明感を出す処理を追加。
  参考 http://mailsrv.nara-edu.ac.jp/~asait/open_gl/opengl.htm#section35
・Open-GL 連続線軌跡を検討するがいいアイデアがでない。（自己再計算する？）
・マウスボタンの状態取得、視点、マニュアル操作モードの機体操作を追加。ホィールはうまく状態がえられない。
・バックアップ
・ヘルプファイル、アバウト・ダイアログの調査
・ＧＵＩに終了ボタンを追加した。
・ＧＵＩダイアログ表示位置を指定した。
・_spawnlによりnotepad.exeでreadme.txtを表示することでヘルプの代用とした。
・本筋から横道にそれやすい。◎印を優先的に検討する。
・ダイアログ多重呼び出し防止方法検討
・ダイアログから時間履歴データ選択機能を追加。

2005.11.14 mon
・モデル表示がちらついていた。
　位置移動を見直し改善した。
・初期位置が正しく表示されない。ファイル読み込み変数などを見直し改善した。
・メッシュ表示がモデル表示、軌跡表示の前後関係に関わらず前面に表示される。
　メッシュ表示のディスプレィ・リスト作成時にディプス・バッファを有効にする。
・本Readme.txtを作成した。
・ファイル入力処理エラー・メッセージを表示させた。
・デルタ軌跡モデルの反転表示を改善した。
・マウスボタン状態の取得を調査

------------------------------------------------------------------------
作業計画: ◎優先事項

・ソースファイル分割（Ｃ関数整理）

・機能対応ソース検索用キーワード埋め込み

・他のVRML, SRFを読み込む。

------------------------------------------------------------------------
わかったこと

・角度情報は、方向余弦行列で座標変換できない。クォータニオン更新か、
　オイラー角更新行列を使う。

・方向余弦、オイラー角、クォータニオンの関係（疑問点有り）
・クォータニオン、方向余弦行列から求めたオイラー角を前回値を評価して
　±180degにした。

・Open-GLでのASCII文字表示方法ライトＯＦＦ、視点は正面。
・Open-GL 日本語表示は可能であるが全体のカラー表示がおかしくなる。
・Open-GL 線の太さ変更できる。
・Open-GL 透明感を出す方法。ブレンドでアルファ値を有効にする。行き先の背景色に注意。
・****.datの場合軌跡表示のデルタモデルが反転する。（左翼端（負）スケールに使用したから）
・Open-GLプログラムは、壁紙チェンジャー動作中に実行させると、
　スクリーン・セイバー起動時にハングアップする。
・Open-GLで複数窓起動時は、制御ポインタに工夫が必要。
・Open-GL 複数画面の再起動時は、OnSize用初期化フラグのリセットが必要。
・Open-GL 翼端軌跡の連続線表示ができた。

・Windows モードレス・ダイアログ起動方法
・Windows Windowの位置サイズ変更
・Windows マウスボタン状態の取得方法(GLUT,DirectX,BlueImpalseなら可能）
・Wiodows ファイル選択ダイアログ処理方法。
・Windows ダイアログの多重起動は、呼び出し時フラグをセットしOnClose関数でリセットする。
・Windows スライダー、エディットボックス、コンボボックス、チェックボックスの使い方。
・Windows ファイル選択でフォルダ移動したあと、ヘルプ・ファイルが開けない。
　　　　　起動時カレント・パスを取得し、移動させることで処理する。
・Windows ダイアログの再初期化は、初期化関数を呼び出す。
・Windows モードレス・ダイアログの消去方法。
・Windows Return Key は、OnOK関数で処理する。
・Windows OnOK と KEYDOWNは競合する。
・Windows システム・メニューにバージョン情報を追加。

・C/C++ ファイル入力で倍精度変数の場合、%lgとする。
・ファイル名をCStringで取得した場合、Char配列に変換できない。
			_tcscpy( m_tmp, m_ModelName);でコピーできる。

・VRMLモデル分析（他のモデルは対応できない）、法線ベクトルの追加が必要。
・２Ｄグラフ表示方法
・グラフ表示の自動スケール方法。
・グラフ表示を非周期処理にする方法。

------------------------------------------------------------------------
問題点／疑問点

・オイラー角更新行列の定義のピッチ項が正しくない。
・オイラー角と方向余弦による座標変換に差がでる。
・オイラー角とクォータニオンに差がでる。( q3!=0.0 .vs. psi==0.0 )
・ピッチ角が ±90deg範囲しか表示できない。-asin(DCM.d20)

・Windows Keydown メッセージで、enter,esc を使うとハングアップする。
　また、TAB 矢印キーに反応しない。F1キーはWindowsHelp
・Windows 英数字のdefine定義がない。
・Windows タイマー起動は、速度的に不十分。
・Windows マウス・ホィール状態の取得（マウスが故障している？？？）
・Windows ラジオボタンの使い方が分からない。
・Windows Window表示座標 0,0 で左上すみに表示されず中央に表示される。
・Windows SWP_NOZODERを無効にしてもベース窓を有効にしても前面に表示されない。
・Windows CStringに実数値を文字列変換して代入する方法がわからない。

・フリーソフト／モデルデータは使用しない。BlueImpalse etc.
・Ｃ言語に依存しており、Ｃ＋＋文法になれない。オブジェクト構造が推進されない。
・べた書きでソース・トレースしにくい。

・ステップバッグからステップフォワードを指示した場合、ジャンプする。

------------------------------------------------------------------------
キーワード
VRML
Open-GL
クォータニオン
方向余弦
座標変換
３次元表示
グラフ表示
Windowsダイアログプログラム
C/C++

------------------------------------------------------------------------
製作開始 2005.10.02 辻本邦之
------------------------------------------------------------------------
