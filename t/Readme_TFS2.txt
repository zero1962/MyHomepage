-------------------------------------------------------------------------------


３次元モデル簡易シミュレータ改　Ver 1.0


[ ThreeFlightSim改( TFS2 と称する ) JavaScript/Three.js ]


2018.08.11 Kuniyuki.Tsujimoto
-------------------------------------------------------------------------------
1. 概要：

これまで簡易フライトシミュレータと称していましたが、機体ダイナミクスの運動方程式を解いて
いるわけでもなく空力特性や物理運動を模擬しているわけではないので、フライトシミュレータ
と称するのはおこがましいと感じまして、改名いたしました。

単純に位置の変化量、姿勢の変化量をクォータニオンで座標変換しなが積算することで
３次元モデルをさまざまな角度から表示できるツールです。

同梱されている３次元モデルは、RV-6A, MU-300, MU-2, CitationX,  Delta の３つです。

RV-6A は、岐阜県の各務ケ原航空宇宙博物館のボランティア NPO法人 MACH B&F の
メンバーが手作りした機体のカラーリングデザインモデルです。

http://www.machbaf.org/

フリーのフライトシミュレータ FlightGear の公式追加機体として登録してあります。

https://home.flightgear.org/

http://www.flightgear.jpn.org/

http://mirrors.ibiblio.org/flightgear/ftp/Aircraft/

CitationX は、山川総司氏作のフリーフライトシミュレータ　YSFlight 用にユーザが
製作されたものを、データ形式を変換して表示可能にしました。

http://ysflight.in.coocan.jp/ysflight/ysflight/j.html

http://ysfinder.net/page.php?air_id=1338

-------------------------------------------------------------------------------
2. 実行方法：
本パッケージは、Windowsパソコン上の適当なフォルダにzip解凍してください。
本アプリケーションは、ローカルパソコン上でも動作するWEBアプリです。

展開されたフォルダ内のThreeFlightSim改.htmlをブラウザで開くことで実行できます。

推奨ブラウザ：Firefox

本アプリケーションは、JavaScript で記述されており、必要なパッケージもすべてそろって
おりますので、自由に改造できます。コンパイラ不要でありFirefoxのウェブ開発機能を使う
ことで手軽にデバッグできます。

本アプリケーションは、JavaScript の多くの要素を含んだサンプルプログラムであり、
自由に応用してください。

-------------------------------------------------------------------------------
3. 実飛行データ等の表示データの再生手順：

(1) 起動後、右上のMenuで「Open Controls」をクリック、「Setting」をクリック

(2) チェックボックスの「RePlay」にチェックを入れる。

(3) 上から２つ目の「RePlay」をクリックするとファイル選択ダイアログが開く。

(4) 展開したThreeFlightSim改フォルダの中から、表示データ「Flight_Data.txt」を
　　選択し、開く。

(5) 「Setting」を再度クリックすると「Setting」の項目が折りたたまれる。

(6) 「View」をクリックし、好みの視点モードをを選ぶ。例：「OutSide」は機体外部からの視点

(7) 「View」を再度クリックすると「View」の項目が折りたたまれる。

(8) 「Close Controls」をクリックしてMenuを閉じる。

(9) 表示データは繰り返し再生される。

(10) ブラウザのリロードをクリックすることで初期状態に戻る。

-------------------------------------------------------------------------------
4. 表示再生データのフォーマット定義

(1) データ並び：
時刻, 位置x(左右),　位置y(高度),　位置z(前後),　Pitch(rad),　Yaw(rad),　Roll(rad)

Flight_Data[Tc] = Time.toFixed(2)+', '+P.x+', '+P.y+', '+P.z+', '+mesh_P+', '+ mesh_Y+', '+mesh_R + '\n';

(2) ファイル形式：
UTF-8形式文字コードのテキストファイル

(3) ファイル名：（例）Flight_Data.txt

実飛行データを扱う場合、経度、高度、緯度をそのまま位置のに適用すると初期位置が
画面の中央にならないため、初期の緯度経度高度からの変位量に変換して適用してください。
表示スケールは実変位量の場合、可視範囲に表示できない場合があるので、適度に縮小して
適用してください。
-------------------------------------------------------------------------------
5. 特殊な操作方法：

本アプリケーションは、iPhoneアプリのHascLoggerと連動し、iPhoneを傾けることで、
ThreeFlightSim改で表示している３次元モデルを操作することができる。

ただし、実行するWindowsパソコンには、Node.js for Windowsがインストールされていること。
WindowsパソコンとiPhoneは同じWiFi配下にあること。

https://qiita.com/taiponrock/items/9001ae194571feb63a5e


(1) iPhone上でHascLoggerを起動する。

(2) HascLoggerの設定は、以下とする。
　　・Gyro 有効、10Hz
    ・Send to Network 有効
    ・IP:Port      WindowsパソコンのIPアドレス ： 8001 ( ex.192.168.0.14： 8001 )
    ・Use Hasc Log Format 有効

(3) Start Sensing Immediately をタップ　-> iPhoneで姿勢検出しUDPで送信開始される。

    iPhoneは水平にしておく。

(4) Node_UDP_AJAX.BAT クリック -> コマンドプロンプトで以下の状態となる。
server listening 0.0.0.0:8001
REQ_GET running at http://localhost:8080/

(5) ThreeFlightSim改.htmlをブラウザで開く

(6) Open Controls > Setting > UDP_Play にチェックを入れる。

(7) Button にチェックを入れる。

(8) Setting > Close Controls をクリックしMenuを閉じる。

(9) 「Go」 ボタンをクリックして速度が「60」を超えるあたりで再度「Go」ボタンをクリックする

(10) iPhoneを少し縦に引き起こすと離陸できる。適当な高度でiPhoneを水平に戻す。

(11) 適当にiPhoneを左右に傾けると機体は左右に旋回する。

(12) 「STP」ボタンを２度クリックすると機体は初期位置に戻る。

(13) ブラウザをリロードすることでTF2は初期状態となる。

(14) ブラウザ、コマンドプロンプトを閉じる。

(15) iPhone上のHascLogger をダブルタップし姿勢検出を停止する。

(16) iPhone上のHascLogger を終了する。

この操作では、JavaScript で困難と思われたリアルタイムな外部入力に対する
応答処理を、UDP通信、サーバサイドJavaScript、Node.js、Ajax/GET 通信の応用方法が
確立できました。

-------------------------------------------------------------------------------
6. 特殊な操作方法（その２）

上記、iPhone上のHascLogger の代わりにジョイスティックや、ゲームパッド、マウス
キーボードでもTFS2上の３次元モデルを操作できる。

(1) Windowsパソコンにジョイスティックもしくはゲームパッドを接続しておく。

(2) 同梱のDinput_Testフォルダ内の Dinput.exe を実行。

(3) 同梱のUDP_Textフォルダ内のUDP_Text_Send.BAT を実行。

以降は 5.(4) 以降と同じ。

-------------------------------------------------------------------------------

7. 開発の経緯：
-------------------------------------------------------------------------------
ThreeFlightSim2 (Ver 1.0) 3D model Flight Simulation software
Coded by kuniyuki.tsujimoto @ 2017.08.17 using three.js and Quaternion.
-------------------------------------------------------------------------------
No need compile and without special 3D viewer,
You can display any three-dimensional models in only Web browser.
The VRML Aircraft Museum,
There are a lot of three-dimensional(VRML format) aircraft models data.
Converting them into obj format by Blender, you can display all.
You can view the three-dimensional display in WindowsPC / Mac / Linux / iOS.
-------------------------------------------------------------------------------
kuniyuki.tsujimoto1182@nifty.com
http://zero1962.world.coocan.jp/
Please check me @ FaceBook.
-------------------------------------------------------------------------------
◎良いところ：
・スマホのジャイロで操縦できます。
・特別な３Ｄ表示ビューアを必要としない。
・iPhoneでもPCでも同じデータが表示できる。
・コンパイル不要。
・クオータニオンを使っているのでジンバルロックしない。
・VRMLエアクラフト博物館のモデルは変換すれば全部表示可能。
・お金がかからない。
・遠くに明石大橋が見えます。
-------------------------------------------------------------------------------
○使い方：
・ボタンをクリックして操作します。1Click 加速, 2Click 巡行.
・iOSの場合、画面をスライドして拡大縮小視点変更できます。
・PCの場合、マウス操作で拡大縮小視点変更できます。
・VRML/MMDのモデルは、BlenderでOBJ/MTL形式ファイルに変換することで表示できます。

アイコンクリック   ==>	(START)   ==> MU-300 が Cockpitで表示される。
			  |
プルダウン選択	   ==>	(View)    ==> Runway,Cockpit etc.
			  |
プルダウン選択	   ==>	(Field)   ==> BaseSet, KobeAirport  etc.
			  |
プルダウン選択	   ==>	(SkyType) ==> Skybox,  etc.
			  |
プルダウン選択	   ==>	(Models)  ==> モデル機種  RV-6A, MU-300, MU-2, CitationX,  Delta
			  |
プルダウン選択	   ==>	(Setting) ==> ボタン表示、Gyro使用など
			  |
ボタン操作	   ==>	(Bottun)  ==> 機体操縦、カメラ操作
			  |
端末Gyro	   ==>	(Gyro)    ==> 機体操縦、カメラ操作
			  |
WindowCloze	   ==>	(END)

【ボタン定義】
・Model：表示モデル切替 3モデル収録。
  RV-6A, CitationX,  Delta
・View ：カメラ視点切替
・VTOL/HOVER/PLANE ：推力変更
・RL：左ロール
・RR：右ロール
・PU：ピッチアップ
・PD：ピッチダウン
・YL：左ヨー
・YR：右ヨー
・Go：スロットルアップ
・Bk：ストットルダウン
・STP：ストップ、RST：初期位置に戻る。
・ＰＣでは、W,A,S,D / Up,Down,Left,Rightで操作可能

【文字表示定義】
・this source.　<- クリックするとソースが表示される。
・Time：経過時間
・Px/Py/Pz：機体位置
・Pitch/Yaw/Roll
・Vz ：機軸方向速度
・Vcz：機軸方向速度

【Control メニュー】
・Gyro:ジャイロ操縦モード
・RePlay：飛行データの再生（ファイル選択）
・log ：飛行データ記録開始／終了（ファイル出力）
・Camera：カメラ操作モード
・Rudder：操舵面表示
・INT ：
・Speed：速度変更
・Zoom：カメラ位置の変更
・PCでは、Hを押すと Open Controls ( dat.GUI )が隠れる。
-------------------------------------------------------------------------------
□注意事項：
・IE10以下では、動作しません。
-------------------------------------------------------------------------------
△問題点：
(13) Obj/Mtl でC172やA6M2とかプロペラ機をフォルダから読み込んだ場合、プロペラがない。->モデルを変える。
(12) Pmd/Pmxをフォルダ読込が成功しない。NG 2018.02.12
(11) 物理運動を追加したら非常に動作が遅くなった。（スイッチでON/OFFさせる)2017.10.08
(1) 機体表面のスームスシェーディングできない。(RV-6A以外)
(2) プロペラ、タイヤの回転表示方法不明（サンプルを分析する。）2017.08.29 解決
(3) 地上走行時脚が消えてしまう。解決
(4) 尾輪接地機体（A6M2,KI-61)は、地上走行せずそのまま離陸してしまう。2017.08.30 解決
(5) 羽田空港風景データはPCローカルで表示できるが、iPhoneでは表示できない。
(6) iPhoneでは、ダブルタップすると表示サイズが変わってしまう。
(7) Texture付コンコルドは、iOSで表示できなかった。
(8) ドロップシャドウが表示できない？( 2017.08.26 )解決しかし、OBJはNG
(9) シャドウメッシュも表示できない？( 2017.08.26 )
(10) FMV2ではKey入力不能　解決？
-------------------------------------------------------------------------------
▽その他：
・改造再配布は、ご自身の責任でお願いします。
・ご意見、ご質問は、上記にメール願います。
・要望、アイデアをお待ちしております。
・VTOLボタンの表示をPLANE に切り替えたい 2017.08.29 解決
・STOPボタンの表示をRESTARTに切り替えたい2017.08.29 解決
・ミッションの表示
・ターゲットをパッシングすると１０点
・ターゲットをパッシングするまでの最速時間記録
・指定時間ないに何回ターゲットをパッシングできるか
・規定どおり着陸できるか
・宇宙用ThreeFlight 2017.09.09 ThreeSpace作成済
・Carは、左右のみ
-------------------------------------------------------------------------------
◇履歴：

2018.06.14 thu
・実機飛行教育支援機材サポート用に改修

2018.05.03 thu
・モデル一覧をファイル定義、配列化する。

2018.04.29 sun
・149個目の機体モデル登録済

2018.04.20
・PFD,FI,PLOT機能追加

2018.04.12 thu
・jQuery Flight Indicators Plugin

2018.02.18 sun
・宇宙背景の組み込み完了
・軍用機、民間機、WWII機体、その他、67モデル登録

2018.02.14
・視点モード選択をプルダウンに登録する ok
・事務所モデルを登録する
・Gyro ONすると視点もうごいてしまい制御できないことの解決。OK

2018.02.12
・起動時ボタンを非表示としモデルビューワーシミュレータを切り替える ok
・フライトデータの読込書き出しを完成させる。Ok

2018.02.04 sun
・ﾓﾃﾞﾙﾃﾞｰﾀの事前読み込みをやめ、その都度、ファイル読み込みとした。
・スマホのジャイロ出力読み込み可能になった。

2018.02.03 sat
・Skydome/Stars追加

2017.10.08 sun
物理運動追加
・揺れる布
・ブロック崩し壁
・砲弾が当たると破壊されるオブジェ
・砲弾発射機能

2017.10.01 sun
・飛行データ・ファイル読み込み、飛行再生機能追加

2017.09.29 fri
・飛行データ記録、ファイル出力機能追加

2017.09.22 fri
・編隊飛行の僚機表示追加

2017.09.21 thu
・Cameraモードでは、操作ボタンでカメラ位置方向を操作できる。

2017.09.02 sat
・ドロップシャドウ処理
・ミッション課題：メッセージ表示
・AI2のモデル変更不良
・Deltaモデルの操縦表示追加
・AI1/AI2の姿勢表示改善
・PCKey入力不能
・STPの後、方向変更できない。
2017.08.31 thu
・Key入力操作対応
・モデル切替時不良の改善
・SH60J,Takanami,BS-Yamato,GT-Rを追加
2017.08.30 wed 下記の機能追加
・操作中のボタンの色を変更する。
・モデルとビューのボタン表示を変更する
・舵面表示をMenuでオン／オフする
2017.08.26 sat 機体追加 Concorde2,C172A
2017.08.24 thu Ver 1.1 機能拡張
2017.08.17 thu Ver 1.0 新規コーディング
2017.01.11 wed 時間と共に視点と機体が切替るデモ機能追加
2017.01.09 mon GuiMENUで表示モデルを選択できるようになった。
2016.11.28 mon Textureのパスはsetpathで通るようになった。
2016.11.12 sat FireFox最新版ならOBJLoaderがローカルPCで実行できる。
2016.11.11 fri Ver 1.3
2016.11.10 thu 自作クォータニオン関数による航法計算で問題解決できた。
2016.11.10 thu 仕様追加
2016.11.09 wed クォータニオン関数化
2016.11.07 mon ランダム地形、太陽光、鳥の群れ、霧
2016.11.01 tue 簡易機体形状、練習用飛行経路設定した。
2016.10.30 sun Camera Lookup 成功。ｺｸﾋﾟｯﾄﾋﾞｭｰも改善し、MRJ90版も作成した。
2016.10.29 sat 古いIE9/Chrom(on WindoesVista)では動作しない。
2016.10.28 fri 数値表示できた。しかし、iOSでは表示できない。
2016.10.22 Ver 1.0 新規コーディング
--------------------------------------------------------------------------- -->
